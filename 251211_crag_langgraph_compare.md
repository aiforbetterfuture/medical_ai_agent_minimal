# Corrective RAG ë° LangGraph ì•„í‚¤í…ì²˜ ìƒì„¸ ë¶„ì„

ì‘ì„±ì¼: 2024-12-11
ë²„ì „: 1.0
ì£¼ì œ: **í˜„ì¬ ìŠ¤ìºí´ë“œì˜ Corrective RAG ìˆœí™˜ êµ¬ì¡°, í’ˆì§ˆ ì¸¡ì •, ì„±ëŠ¥ ë¶„ì„**

---

## ğŸ“‹ ëª©ì°¨

1. [Corrective RAG ìˆœí™˜ êµ¬ì¡°](#1-corrective-rag-ìˆœí™˜-êµ¬ì¡°)
2. [í’ˆì§ˆ ì¸¡ì • ê¸°ì¤€ ë° ì•Œê³ ë¦¬ì¦˜](#2-í’ˆì§ˆ-ì¸¡ì •-ê¸°ì¤€-ë°-ì•Œê³ ë¦¬ì¦˜)
3. [LangGraph ì•„í‚¤í…ì²˜ì—ì„œì˜ ë…¸ë“œ ì—°ê²°](#3-langgraph-ì•„í‚¤í…ì²˜ì—ì„œì˜-ë…¸ë“œ-ì—°ê²°)
4. [ì„±ëŠ¥ ê°œì„  íš¨ê³¼ ìˆ˜í•™ì  ë¶„ì„](#4-ì„±ëŠ¥-ê°œì„ -íš¨ê³¼-ìˆ˜í•™ì -ë¶„ì„)
5. [Corrective RAG ë¯¸ì‚¬ìš© ì‹œ ì˜í–¥ ë¶„ì„](#5-corrective-rag-ë¯¸ì‚¬ìš©-ì‹œ-ì˜í–¥-ë¶„ì„)
6. [ì „ì²´ ì•„í‚¤í…ì²˜ í’ˆì§ˆ ì¸¡ì •ê³¼ì˜ ì°¨ë³„ì„±](#6-ì „ì²´-ì•„í‚¤í…ì²˜-í’ˆì§ˆ-ì¸¡ì •ê³¼ì˜-ì°¨ë³„ì„±)
7. [ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­](#7-ê²°ë¡ -ë°-ê¶Œì¥ì‚¬í•­)

---

## 1. Corrective RAG ìˆœí™˜ êµ¬ì¡°

### 1.1 ê°œìš”

í˜„ì¬ ìŠ¤ìºí´ë“œëŠ” **Self-Refine ê¸°ë°˜ Corrective RAG** êµ¬ì¡°ë¥¼ LangGraphë¡œ êµ¬í˜„í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ëŠ” ìƒì„±ëœ ë‹µë³€ì˜ í’ˆì§ˆì„ í‰ê°€í•˜ê³ , í’ˆì§ˆì´ ë‚®ì„ ê²½ìš° ì¬ê²€ìƒ‰ì„ ìˆ˜í–‰í•˜ëŠ” ìˆœí™˜ êµ¬ì¡°ì…ë‹ˆë‹¤.

### 1.2 ìˆœí™˜ êµ¬ì¡° í”Œë¡œìš°

```
[retrieve] â†’ [generate_answer] â†’ [refine] â†’ [quality_check]
                                               â†“
                                         í’ˆì§ˆ í‰ê°€
                                               â†“
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â†“                     â†“
                            quality < threshold    quality â‰¥ threshold
                            AND iter < max_iter          OR
                                    â†“              iter â‰¥ max_iter
                              [retrieve]                 â†“
                              (ì¬ê²€ìƒ‰)           [store_response]
                                                         â†“
                                                       [END]
```

### 1.3 í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜

#### 1.3.1 ì¬ê²€ìƒ‰ íŠ¸ë¦¬ê±° ì¡°ê±´

ì¬ê²€ìƒ‰ì€ ë‹¤ìŒ ë‘ ì¡°ê±´ì„ **ëª¨ë‘** ë§Œì¡±í•  ë•Œ ë°œìƒí•©ë‹ˆë‹¤:

```python
# agent/nodes/refine.py:53-56
needs_retrieval = (
    quality_score < threshold and
    state.get('iteration_count', 0) < max_iter
)
```

**ì¡°ê±´ ë¶„ì„**:
1. `quality_score < threshold`: í’ˆì§ˆ ì ìˆ˜ê°€ ì„ê³„ê°’ ë¯¸ë§Œ
   - ê¸°ë³¸ ì„ê³„ê°’: `0.5` (feature_flags['quality_threshold'])
2. `iteration_count < max_iter`: ë°˜ë³µ íšŸìˆ˜ê°€ ìµœëŒ€ì¹˜ ë¯¸ë§Œ
   - ê¸°ë³¸ ìµœëŒ€ ë°˜ë³µ: `2` (feature_flags['max_refine_iterations'])

#### 1.3.2 ë°˜ë³µ íšŸìˆ˜ ê´€ë¦¬

```python
# agent/nodes/retrieve.py:74-79
if state.get('answer', ''):
    state['iteration_count'] = state.get('iteration_count', 0) + 1
else:
    # ì²« ê²€ìƒ‰ì¸ ê²½ìš° 0ìœ¼ë¡œ ì´ˆê¸°í™”
    state['iteration_count'] = 0
```

**íŠ¹ì§•**:
- ì´ë¯¸ ë‹µë³€ì´ ìƒì„±ëœ ê²½ìš°ì—ë§Œ `iteration_count` ì¦ê°€
- ì²« ê²€ìƒ‰ì€ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì—¬ ìµœëŒ€ 3ë²ˆ ê²€ìƒ‰ ê°€ëŠ¥ (0, 1, 2)

#### 1.3.3 ìˆœí™˜ êµ¬ì¡°ì˜ LangGraph êµ¬í˜„

```python
# agent/graph.py:60-71
workflow.add_edge("retrieve", "generate_answer")
workflow.add_edge("generate_answer", "refine")

# ì¡°ê±´ë¶€ ì—£ì§€ (í’ˆì§ˆ ê²€ì‚¬)
workflow.add_conditional_edges(
    "refine",
    quality_check_node,
    {
        "retrieve": "retrieve",  # ì¬ê²€ìƒ‰
        END: "store_response"    # ì‘ë‹µ ìºì‹± í›„ ì¢…ë£Œ
    }
)
```

**LangGraphì˜ ì¡°ê±´ë¶€ ì—£ì§€**:
- `quality_check_node` í•¨ìˆ˜ì˜ ë°˜í™˜ê°’ì— ë”°ë¼ ë‹¤ìŒ ë…¸ë“œ ê²°ì •
- `"retrieve"` ë°˜í™˜ ì‹œ: ì¬ê²€ìƒ‰ ë£¨í”„
- `END` ë°˜í™˜ ì‹œ: ì‘ë‹µ ìºì‹± í›„ ì¢…ë£Œ

### 1.4 Corrective ë©”ì»¤ë‹ˆì¦˜ì˜ íŠ¹ì§•

#### 1.4.1 ì ì‘í˜• ê²€ìƒ‰ (Adaptive Retrieval)

ì¬ê²€ìƒ‰ ì‹œ ë‹¤ìŒ ìš”ì†Œë“¤ì´ **ë™ì ìœ¼ë¡œ ì¡°ì •**ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

1. **ì¿¼ë¦¬ ì¬ì‘ì„±** ([retrieve.py:31-53](retrieve.py#L31-L53)):
   ```python
   rewritten_query = _rewrite_query(state['user_text'], slot_out, profile_summary, feature_flags)
   ```
   - ìŠ¬ë¡¯ ì •ë³´ (ë‚˜ì´, ì„±ë³„, ì§ˆí™˜, ì•½ë¬¼) í¬í•¨
   - í”„ë¡œí•„ ìš”ì•½ ì¶”ê°€
   - ë§¥ë½ì´ ê°•í™”ëœ ì¿¼ë¦¬ë¡œ ì¬ê²€ìƒ‰

2. **ë¼ìš°íŒ… ì „ëµ** ([retrieve.py:14-28](retrieve.py#L14-L28)):
   ```python
   route = _select_route(slot_out, feature_flags)
   # route: 'medication', 'symptom', 'default'
   ```
   - ì•½ë¬¼ ì–¸ê¸‰ ì‹œ â†’ `medication` ë¼ìš°íŠ¸
   - ì¦ìƒ/ì§ˆí™˜ ì–¸ê¸‰ ì‹œ â†’ `symptom` ë¼ìš°íŠ¸
   - ê° ë¼ìš°íŠ¸ë³„ë¡œ ë‹¤ë¥¸ ì¸ë±ìŠ¤/ì½”í¼ìŠ¤ ì‚¬ìš©

3. **í† í° ì˜ˆì‚° ê¸°ë°˜ k ì¡°ì •** ([retrieve.py:129-142](retrieve.py#L129-L142)):
   ```python
   docs_budget = token_plan.get('for_docs', 900)
   avg_doc_tokens = feature_flags.get('avg_doc_tokens', 200)
   max_k_by_budget = max(1, docs_budget // max(1, avg_doc_tokens))
   final_k = min(base_k, max_k_by_budget)
   ```
   - í† í° ì˜ˆì‚°ì— ë”°ë¼ ê²€ìƒ‰ ë¬¸ì„œ ìˆ˜ ë™ì  ì¡°ì •
   - ì˜ˆì‚° ì´ˆê³¼ ì‹œ ë¬¸ì„œ ìˆ˜ ì œí•œ

#### 1.4.2 Self-Refine ë£¨í”„ì˜ ì´ì 

1. **ì ì§„ì  í’ˆì§ˆ í–¥ìƒ**:
   - 1ì°¨ ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ê¸°íšŒ ì œê³µ
   - ì¿¼ë¦¬ ê°œì„ ì„ í†µí•œ ë” ë‚˜ì€ ë¬¸ì„œ ê²€ìƒ‰

2. **ë§¥ë½ ê°•í™”**:
   - ë°˜ë³µë§ˆë‹¤ ìŠ¬ë¡¯ ì •ë³´ê°€ ëˆ„ì  ê°€ëŠ¥
   - í”„ë¡œí•„ ì •ë³´ê°€ ì¿¼ë¦¬ì— í†µí•©ë¨

3. **ë¹„ìš©-í’ˆì§ˆ ê· í˜•**:
   - ë¬´í•œ ë£¨í”„ ë°©ì§€ (ìµœëŒ€ 2íšŒ)
   - í’ˆì§ˆì´ ì¶©ë¶„í•˜ë©´ ì¡°ê¸° ì¢…ë£Œ

---

## 2. í’ˆì§ˆ ì¸¡ì • ê¸°ì¤€ ë° ì•Œê³ ë¦¬ì¦˜

### 2.1 í’ˆì§ˆ ì ìˆ˜ ê³„ì‚° ê³µì‹

í˜„ì¬ êµ¬í˜„ëœ í’ˆì§ˆ ì ìˆ˜ëŠ” **3ê°€ì§€ í•˜ìœ„ ì ìˆ˜ì˜ ê°€ì¤‘ í‰ê· **ì…ë‹ˆë‹¤:

```python
# agent/nodes/refine.py:32-48
quality_score = (
    length_score * 0.3 +
    evidence_score * 0.4 +
    personalization_score * 0.3
)
```

### 2.2 í•˜ìœ„ ì ìˆ˜ ìƒì„¸ ë¶„ì„

#### 2.2.1 Length Score (ë‹µë³€ ê¸¸ì´ ì ìˆ˜)

**ê³µì‹**:
```
length_score = min(len(answer) / 500, 1.0)
```

**ìˆ˜í•™ì  í‘œí˜„**:
```
L(a) = min(|a| / 500, 1.0)

where:
  a = ë‹µë³€ í…ìŠ¤íŠ¸
  |a| = ë‹µë³€ì˜ ë¬¸ì ìˆ˜
```

**íŠ¹ì§•**:
- 500ì ì´ìƒì´ë©´ ìµœëŒ€ ì ìˆ˜ 1.0
- 500ì ë¯¸ë§Œì´ë©´ ë¹„ë¡€ì ìœ¼ë¡œ ê°ì†Œ
- ì˜ˆì‹œ:
  - 250ì â†’ 0.5
  - 100ì â†’ 0.2
  - 600ì â†’ 1.0

**ì˜ë¯¸**:
- ì¶©ë¶„í•œ ì„¤ëª…ì„ ì œê³µí•˜ëŠ” ë‹µë³€ ì„ í˜¸
- ë„ˆë¬´ ì§§ì€ ë‹µë³€ì€ ë¶ˆì™„ì „í•œ ê²ƒìœ¼ë¡œ ê°„ì£¼

#### 2.2.2 Evidence Score (ê·¼ê±° ì ìˆ˜)

**ê³µì‹**:
```python
evidence_score = 1.0 if len(retrieved_docs) > 0 else 0.0
```

**ìˆ˜í•™ì  í‘œí˜„**:
```
E(D) = {
  1.0  if |D| > 0
  0.0  if |D| = 0
}

where:
  D = ê²€ìƒ‰ëœ ë¬¸ì„œ ì§‘í•©
  |D| = ë¬¸ì„œ ê°œìˆ˜
```

**íŠ¹ì§•**:
- ì´ì§„ ì ìˆ˜ (0 ë˜ëŠ” 1)
- ìµœì†Œ 1ê°œì˜ ë¬¸ì„œë§Œ ìˆìœ¼ë©´ ë§Œì 
- ë¬¸ì„œ ê°œìˆ˜ë‚˜ í’ˆì§ˆì€ ê³ ë ¤í•˜ì§€ ì•ŠìŒ

**ì˜ë¯¸**:
- ê·¼ê±° ê¸°ë°˜ ë‹µë³€ ê°•ì œ
- ê²€ìƒ‰ ì‹¤íŒ¨ ì‹œ ì¬ê²€ìƒ‰ ìœ ë„

#### 2.2.3 Personalization Score (ê°œì¸í™” ì ìˆ˜)

**ê³µì‹**:
```python
personalization_score = 1.0 if profile_summary else 0.0
```

**ìˆ˜í•™ì  í‘œí˜„**:
```
P(p) = {
  1.0  if p â‰  âˆ…
  0.0  if p = âˆ…
}

where:
  p = í”„ë¡œí•„ ìš”ì•½ í…ìŠ¤íŠ¸
  âˆ… = ë¹ˆ ë¬¸ìì—´
```

**íŠ¹ì§•**:
- ì´ì§„ ì ìˆ˜ (0 ë˜ëŠ” 1)
- í”„ë¡œí•„ ì •ë³´ ì¡´ì¬ ì—¬ë¶€ë§Œ í™•ì¸
- í”„ë¡œí•„ í’ˆì§ˆì´ë‚˜ í™œìš©ë„ëŠ” ë¯¸í‰ê°€

**ì˜ë¯¸**:
- ê°œì¸í™”ëœ ë‹µë³€ ì¥ë ¤
- ì‚¬ìš©ì ë§¥ë½ ë°˜ì˜ ê°•ì œ

### 2.3 ì¢…í•© í’ˆì§ˆ ì ìˆ˜ ìˆ˜ì‹

**ì™„ì „í•œ ìˆ˜í•™ì  í‘œí˜„**:

```
Q(a, D, p) = 0.3 Ã— L(a) + 0.4 Ã— E(D) + 0.3 Ã— P(p)

where:
  Q(a, D, p) = ì¢…í•© í’ˆì§ˆ ì ìˆ˜ âˆˆ [0, 1]

  L(a) = min(|a| / 500, 1.0)

  E(D) = {
    1.0  if |D| > 0
    0.0  if |D| = 0
  }

  P(p) = {
    1.0  if p â‰  âˆ…
    0.0  if p = âˆ…
  }
```

### 2.4 í’ˆì§ˆ ì ìˆ˜ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„

| ì‹œë‚˜ë¦¬ì˜¤ | ê¸¸ì´ | ë¬¸ì„œ | í”„ë¡œí•„ | L(a) | E(D) | P(p) | Q ì´ì  |
|---------|-----|------|--------|------|------|------|--------|
| **ìµœìƒ** | 600ì | 5ê°œ | ìˆìŒ | 1.0 | 1.0 | 1.0 | **1.0** |
| **ì–‘í˜¸** | 500ì | 3ê°œ | ìˆìŒ | 1.0 | 1.0 | 1.0 | **1.0** |
| **ë³´í†µ** | 300ì | 2ê°œ | ì—†ìŒ | 0.6 | 1.0 | 0.0 | **0.58** |
| **ë¯¸í¡** | 200ì | 1ê°œ | ì—†ìŒ | 0.4 | 1.0 | 0.0 | **0.52** |
| **ë¶ˆëŸ‰** | 100ì | 0ê°œ | ì—†ìŒ | 0.2 | 0.0 | 0.0 | **0.06** |
| **ì¬ê²€ìƒ‰ ë°œìƒ** | 200ì | 0ê°œ | ìˆìŒ | 0.4 | 0.0 | 1.0 | **0.42** < 0.5 âœ“ |

**ì¬ê²€ìƒ‰ íŠ¸ë¦¬ê±° ì˜ˆì‹œ**:
```
threshold = 0.5
ì‹œë‚˜ë¦¬ì˜¤: 200ì, ë¬¸ì„œ ì—†ìŒ, í”„ë¡œí•„ ìˆìŒ
Q = 0.3Ã—0.4 + 0.4Ã—0.0 + 0.3Ã—1.0 = 0.42 < 0.5
â†’ needs_retrieval = True (ì¬ê²€ìƒ‰)
```

### 2.5 í’ˆì§ˆ ì¸¡ì •ì˜ í•œê³„ ë° ê°œì„  ë°©í–¥

#### 2.5.1 í˜„ì¬ êµ¬í˜„ì˜ í•œê³„

1. **ë‹¨ìˆœí•œ ê¸¸ì´ ê¸°ë°˜ í‰ê°€**:
   - ë‹µë³€ì˜ ë‚´ìš© í’ˆì§ˆ ë¯¸í‰ê°€
   - ì¤‘ë³µ, ë¬´ì˜ë¯¸í•œ ë‚´ìš©ë„ ê¸¸ì´ë¡œ ì¸ì •

2. **ì´ì§„ ì ìˆ˜ì˜ í•œê³„**:
   - ë¬¸ì„œ 1ê°œì™€ 10ê°œê°€ ë™ì¼í•œ ì ìˆ˜
   - í”„ë¡œí•„ í™œìš©ë„ ë¬´ì‹œ

3. **ì˜ë¯¸ë¡ ì  í‰ê°€ ë¶€ì¬**:
   - ë‹µë³€ì˜ ì •í™•ì„± ë¯¸í™•ì¸
   - ê·¼ê±°ì™€ ë‹µë³€ì˜ ì¼ê´€ì„± ë¯¸í‰ê°€

#### 2.5.2 ê°œì„  ì œì•ˆ

**ê³ ê¸‰ í’ˆì§ˆ ì ìˆ˜ ê³µì‹**:

```
Q_advanced(a, D, p, q) = wâ‚ Ã— L(a) + wâ‚‚ Ã— E_quality(D) + wâ‚ƒ Ã— P_usage(p, a) + wâ‚„ Ã— R(a, q)

where:
  E_quality(D) = Î£áµ¢ relevance(dáµ¢, q) / |D|  # ë¬¸ì„œ í’ˆì§ˆ í‰ê· 
  P_usage(p, a) = cosine_sim(embed(p), embed(a))  # í”„ë¡œí•„ í™œìš©ë„
  R(a, q) = semantic_relevance(a, q)  # ë‹µë³€ ê´€ë ¨ì„±

  wâ‚ + wâ‚‚ + wâ‚ƒ + wâ‚„ = 1.0  # ê°€ì¤‘ì¹˜ í•© = 1
```

---

## 3. LangGraph ì•„í‚¤í…ì²˜ì—ì„œì˜ ë…¸ë“œ ì—°ê²°

### 3.1 ì „ì²´ ê·¸ë˜í”„ êµ¬ì¡°

```python
# agent/graph.py
workflow = StateGraph(AgentState)

# 9ê°œ ë…¸ë“œ ì •ì˜
nodes = [
    "check_similarity",    # 0. ìºì‹œ í™•ì¸
    "extract_slots",       # 1. ìŠ¬ë¡¯ ì¶”ì¶œ
    "store_memory",        # 2. ë©”ëª¨ë¦¬ ì €ì¥
    "assemble_context",    # 3. ì»¨í…ìŠ¤íŠ¸ ì¡°ë¦½
    "retrieve",            # 4. ê²€ìƒ‰
    "generate_answer",     # 5. ë‹µë³€ ìƒì„±
    "refine",              # 6. Self-Refine
    "quality_check",       # 7. í’ˆì§ˆ ê²€ì‚¬
    "store_response",      # 8. ì‘ë‹µ ì €ì¥
]
```

### 3.2 ë…¸ë“œë³„ ì—­í•  ë° ì—°ê²°

#### 3.2.1 ì§„ì…ì : check_similarity

```python
workflow.set_entry_point("check_similarity")
```

**ì—­í• **:
- ìœ ì‚¬ ì¿¼ë¦¬ ìºì‹œ í™•ì¸
- 85% ìœ ì‚¬ë„ ì„ê³„ê°’ (feature_flags['cache_similarity_threshold'])

**ì¡°ê±´ë¶€ ë¶„ê¸°**:
```python
workflow.add_conditional_edges(
    "check_similarity",
    lambda x: "store_response" if x.get('skip_pipeline', False) else "extract_slots",
    {
        "store_response": "store_response",  # ìºì‹œ íˆíŠ¸ â†’ ì¢…ë£Œ
        "extract_slots": "extract_slots"     # ìºì‹œ ë¯¸ìŠ¤ â†’ ì •ìƒ í”Œë¡œìš°
    }
)
```

**íš¨ê³¼**:
- ìºì‹œ íˆíŠ¸ ì‹œ ì „ì²´ íŒŒì´í”„ë¼ì¸ ê±´ë„ˆë›°ê¸°
- í‰ê·  1.8ì´ˆ â†’ 0.05ì´ˆ ë‹¨ì¶• (97% ê°ì†Œ)

#### 3.2.2 ìˆœì°¨ ë…¸ë“œ ì²´ì¸

```python
workflow.add_edge("extract_slots", "store_memory")
workflow.add_edge("store_memory", "assemble_context")
workflow.add_edge("assemble_context", "retrieve")
workflow.add_edge("retrieve", "generate_answer")
workflow.add_edge("generate_answer", "refine")
```

**íŠ¹ì§•**:
- ê²°ì •ë¡ ì  ìˆœì°¨ ì‹¤í–‰
- ê° ë…¸ë“œëŠ” ì´ì „ ìƒíƒœë¥¼ ë°›ì•„ ì—…ë°ì´íŠ¸ëœ ìƒíƒœ ë°˜í™˜

#### 3.2.3 Corrective RAG ë£¨í”„

```python
workflow.add_conditional_edges(
    "refine",
    quality_check_node,  # ì¡°ê±´ í•¨ìˆ˜
    {
        "retrieve": "retrieve",  # ì¬ê²€ìƒ‰
        END: "store_response"    # ì¢…ë£Œ
    }
)
```

**quality_check_node ë¡œì§** ([quality_check.py:10-38](quality_check.py#L10-L38)):

```python
def quality_check_node(state: AgentState) -> str:
    # LLM ëª¨ë“œ ë˜ëŠ” Self-Refine off â†’ í•­ìƒ ì¢…ë£Œ
    if is_llm_mode(state) or not self_refine_enabled:
        return END

    needs_retrieval = state.get('needs_retrieval', False)
    iteration_count = state.get('iteration_count', 0)

    if needs_retrieval and iteration_count < max_iter:
        return "retrieve"  # ì¬ê²€ìƒ‰
    else:
        return END  # ì¢…ë£Œ
```

**ê·¸ë˜í”„ ì‹œê°í™”**:

```
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ check_similarity â”‚ (ì§„ì…ì )
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ skip_pipeline?       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                        â”‚
    [ìºì‹œ íˆíŠ¸]              [ìºì‹œ ë¯¸ìŠ¤]
         â”‚                        â”‚
         â†“                        â†“
  store_response          extract_slots
         â”‚                        â”‚
         â†“                        â†“
       [END]               store_memory
                                  â”‚
                                  â†“
                          assemble_context
                                  â”‚
                                  â†“
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€retrieveâ—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                       â”‚               â”‚
          â”‚                       â†“               â”‚
          â”‚              generate_answer          â”‚
          â”‚                       â”‚               â”‚
          â”‚                       â†“               â”‚
          â”‚                    refine             â”‚
          â”‚                       â”‚               â”‚
          â”‚                       â†“               â”‚
          â”‚               quality_check           â”‚
          â”‚                       â”‚               â”‚
          â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
          â”‚         â”‚                           â”‚ â”‚
          â”‚    [needs_retrieval &&        [í’ˆì§ˆ OK ||
          â”‚     iter < max_iter]           iter â‰¥ max]
          â”‚         â”‚                           â”‚ â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â†“ â”‚
          (ì¬ê²€ìƒ‰ ë£¨í”„)                  store_response
                                                 â”‚
                                                 â†“
                                               [END]
```

### 3.3 ìƒíƒœ ì „íŒŒ ë©”ì»¤ë‹ˆì¦˜

#### 3.3.1 AgentState íƒ€ì… ì •ì˜

```python
# agent/state.py
class AgentState(TypedDict):
    # Corrective RAG ê´€ë ¨ í•„ë“œ
    quality_score: float          # í’ˆì§ˆ ì ìˆ˜
    needs_retrieval: bool         # ì¬ê²€ìƒ‰ í•„ìš” ì—¬ë¶€
    iteration_count: int          # ë°˜ë³µ íšŸìˆ˜

    # ê²€ìƒ‰ ê´€ë ¨
    retrieved_docs: Annotated[List[Dict], add]  # ë¬¸ì„œ ëˆ„ì 
    query_vector: List[float]

    # ë‹µë³€ ìƒì„±
    answer: str
    system_prompt: str
    user_prompt: str
```

**`Annotated[List[Dict], add]`ì˜ ì˜ë¯¸**:
- LangGraphì˜ íŠ¹ìˆ˜ íƒ€ì…
- ì—¬ëŸ¬ ë…¸ë“œì—ì„œ ë°˜í™˜ëœ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ë¥¼ **ìë™ìœ¼ë¡œ ë³‘í•©**
- ì¬ê²€ìƒ‰ ì‹œ ì´ì „ ë¬¸ì„œ + ìƒˆ ë¬¸ì„œ ëˆ„ì  ê°€ëŠ¥

#### 3.3.2 ìƒíƒœ ì—…ë°ì´íŠ¸ íŒ¨í„´

ê° ë…¸ë“œëŠ” ë‹¤ìŒ íŒ¨í„´ì„ ë”°ë¦…ë‹ˆë‹¤:

```python
def some_node(state: AgentState) -> AgentState:
    # 1. í˜„ì¬ ìƒíƒœì—ì„œ í•„ìš”í•œ ì •ë³´ ì¶”ì¶œ
    user_text = state['user_text']
    feature_flags = state.get('feature_flags', {})

    # 2. ì²˜ë¦¬ ë¡œì§ ìˆ˜í–‰
    result = do_something(user_text)

    # 3. ì—…ë°ì´íŠ¸ëœ ìƒíƒœ ë°˜í™˜ (ê¸°ì¡´ ìƒíƒœ + ìƒˆ í•„ë“œ)
    return {
        **state,  # ê¸°ì¡´ ìƒíƒœ ìœ ì§€
        'new_field': result  # ìƒˆ í•„ë“œ ì¶”ê°€/ì—…ë°ì´íŠ¸
    }
```

**Corrective RAGì—ì„œì˜ ìƒíƒœ ì „íŒŒ ì˜ˆì‹œ**:

```python
# 1ì°¨ ê²€ìƒ‰
retrieve_node(state)
â†’ state['retrieved_docs'] = [doc1, doc2, doc3]
â†’ state['iteration_count'] = 0

# í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨
refine_node(state)
â†’ state['quality_score'] = 0.42
â†’ state['needs_retrieval'] = True

# 2ì°¨ ê²€ìƒ‰ (ìƒíƒœ ëˆ„ì )
retrieve_node(state)
â†’ state['retrieved_docs'] = [doc1, doc2, doc3, doc4, doc5]  # ëˆ„ì 
â†’ state['iteration_count'] = 1

# í’ˆì§ˆ ê²€ì‚¬ ì„±ê³µ
refine_node(state)
â†’ state['quality_score'] = 0.68
â†’ state['needs_retrieval'] = False
```

### 3.4 LangGraphì˜ Corrective RAG êµ¬í˜„ ì¥ì 

#### 3.4.1 ì„ ì–¸ì  ê·¸ë˜í”„ ì •ì˜

**ì¥ì **:
- ìˆœí™˜ êµ¬ì¡°ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í‘œí˜„
- ì¡°ê±´ë¶€ ë¶„ê¸°ê°€ ì½”ë“œì—ì„œ ëª…í™•íˆ ë³´ì„
- ê·¸ë˜í”„ ì‹œê°í™” ê°€ëŠ¥

**ëŒ€ì•ˆ (ì ˆì°¨ì  ì½”ë“œ)ê³¼ ë¹„êµ**:

```python
# ì ˆì°¨ì  ë°©ì‹ (ë³µì¡í•¨)
def run_agent_procedural(user_text):
    iteration = 0
    while iteration < max_iter:
        docs = retrieve(user_text)
        answer = generate(docs)
        quality = evaluate(answer)
        if quality >= threshold:
            break
        iteration += 1
    return answer

# LangGraph ë°©ì‹ (ì„ ì–¸ì )
workflow.add_conditional_edges(
    "refine",
    quality_check_node,
    {"retrieve": "retrieve", END: "store_response"}
)
```

#### 3.4.2 ìƒíƒœ ê´€ë¦¬ ìë™í™”

**ì¥ì **:
- ìƒíƒœ ì „íŒŒë¥¼ LangGraphê°€ ìë™ ê´€ë¦¬
- ë…¸ë“œ ê°„ ë°ì´í„° ì „ë‹¬ ëª…ì‹œì 
- ë¶€ì‘ìš©(side effect) ìµœì†Œí™”

#### 3.4.3 Ablation ì‹¤í—˜ ìš©ì´ì„±

**feature_flagsë¥¼ í†µí•œ On/Off**:

```python
# Self-Refine ë¹„í™œì„±í™”
feature_flags['self_refine_enabled'] = False
â†’ quality_check_nodeê°€ í•­ìƒ END ë°˜í™˜

# ë°˜ë³µ íšŸìˆ˜ ë³€ê²½
feature_flags['max_refine_iterations'] = 1
â†’ ìµœëŒ€ 2íšŒ ê²€ìƒ‰ (0, 1)

# í’ˆì§ˆ ì„ê³„ê°’ ë³€ê²½
feature_flags['quality_threshold'] = 0.7
â†’ ë” ì—„ê²©í•œ í’ˆì§ˆ ê¸°ì¤€
```

**ë…¸ë“œ ì œê±° ì‹¤í—˜**:

```python
# retrieve ë…¸ë“œ ê±´ë„ˆë›°ê¸° (LLM ì „ìš© ëª¨ë“œ)
if mode == 'llm':
    return {'retrieved_docs': []}
```

---

## 4. ì„±ëŠ¥ ê°œì„  íš¨ê³¼ ìˆ˜í•™ì  ë¶„ì„

### 4.1 ì„±ëŠ¥ ë©”íŠ¸ë¦­ ì •ì˜

#### 4.1.1 ë‹µë³€ í’ˆì§ˆ (Answer Quality)

**ì •ì˜**:
```
AQ = Î± Ã— Faithfulness + Î² Ã— Relevance + Î³ Ã— Completeness

where:
  Faithfulness = ê·¼ê±° ë¬¸ì„œì™€ì˜ ì¼ì¹˜ë„ âˆˆ [0, 1]
  Relevance = ì‚¬ìš©ì ì§ˆë¬¸ê³¼ì˜ ê´€ë ¨ì„± âˆˆ [0, 1]
  Completeness = ë‹µë³€ì˜ ì™„ì„±ë„ âˆˆ [0, 1]
  Î± + Î² + Î³ = 1.0
```

**í˜„ì¬ êµ¬í˜„ì—ì„œì˜ ê·¼ì‚¬**:
```
AQ_current â‰ˆ quality_score = 0.3L + 0.4E + 0.3P
```

#### 4.1.2 ê²€ìƒ‰ íš¨ìœ¨ì„± (Retrieval Efficiency)

**ì •ì˜**:
```
RE = Precision@k Ã— Recall@k / Latency

where:
  Precision@k = |Relevant âˆ© Retrieved| / k
  Recall@k = |Relevant âˆ© Retrieved| / |Relevant|
  Latency = ê²€ìƒ‰ ì‹œê°„ (ì´ˆ)
```

#### 4.1.3 í† í° íš¨ìœ¨ì„± (Token Efficiency)

**ì •ì˜**:
```
TE = AQ / Total_Tokens

where:
  Total_Tokens = Context_Tokens + Generation_Tokens
```

### 4.2 Corrective RAGì˜ ì„±ëŠ¥ ê°œì„  ìˆ˜ì‹

#### 4.2.1 í’ˆì§ˆ ê°œì„  ëª¨ë¸

**ê°€ì •**:
- 1ì°¨ ê²€ìƒ‰ ì„±ê³µë¥ : `pâ‚ = 0.70` (70%)
- 2ì°¨ ê²€ìƒ‰ ì„±ê³µë¥ : `pâ‚‚ = 0.85` (85%, ì¿¼ë¦¬ ê°œì„  íš¨ê³¼)
- 3ì°¨ ê²€ìƒ‰ ì„±ê³µë¥ : `pâ‚ƒ = 0.92` (92%, ì¶”ê°€ ê°œì„ )

**ìµœì¢… ì„±ê³µë¥  ê³„ì‚°**:

```
P_success = pâ‚ + (1 - pâ‚) Ã— pâ‚‚ + (1 - pâ‚) Ã— (1 - pâ‚‚) Ã— pâ‚ƒ

ê³„ì‚°:
P_success = 0.70 + 0.30 Ã— 0.85 + 0.30 Ã— 0.15 Ã— 0.92
         = 0.70 + 0.255 + 0.0414
         = 0.9964 â‰ˆ 99.6%
```

**í’ˆì§ˆ ê°œì„ ë¥ **:
```
Î”_quality = (P_success - pâ‚) / pâ‚ Ã— 100%
          = (0.9964 - 0.70) / 0.70 Ã— 100%
          = 42.3%
```

#### 4.2.2 í† í° ë¹„ìš© ëª¨ë¸

**1íšŒ ì‹¤í–‰ë‹¹ í† í° ì†Œë¹„**:

```python
# ê¸°ë³¸ í† í°
T_base = T_context + T_history + T_profile + T_docs + T_generation

# Corrective RAG ì¶”ê°€ í† í°
T_corrective = Î£áµ¢â‚Œâ‚â¿ (T_retrieval_i + T_generation_i)

where:
  n = ì¬ê²€ìƒ‰ íšŸìˆ˜ (0, 1, 2)
  T_retrieval_i = ië²ˆì§¸ ê²€ìƒ‰ì˜ í† í° (ë¬¸ì„œ ì„ë² ë”© ì œì™¸)
  T_generation_i = ië²ˆì§¸ ìƒì„±ì˜ í† í°
```

**ì‹¤ì œ ê³„ì‚° (í‰ê· ê°’)**:

| í•­ëª© | í† í° ìˆ˜ | ë¹„ê³  |
|------|--------|------|
| `T_context` | 600 | ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ |
| `T_history` | 350 | ëŒ€í™” ì´ë ¥ (HAT ì ìš© ì‹œ) |
| `T_profile` | 200 | í”„ë¡œí•„ ìš”ì•½ |
| `T_docs` | 800 | ê²€ìƒ‰ ë¬¸ì„œ (4ê°œ Ã— 200í† í°) |
| `T_generation` | 500 | ë‹µë³€ ìƒì„± |
| **í•©ê³„ (1íšŒ)** | **2,450** | ì¬ê²€ìƒ‰ ì—†ìŒ |

**ì¬ê²€ìƒ‰ ì‹œ ì¶”ê°€ í† í°**:

```
# 2ì°¨ ê²€ìƒ‰ ë°œìƒ ì‹œ (30% í™•ë¥ )
T_retrieval_2 = 800  # ì¶”ê°€ ë¬¸ì„œ
T_generation_2 = 500  # ì¬ìƒì„±
T_total_with_retry = 2,450 + 800 + 500 = 3,750

# 3ì°¨ ê²€ìƒ‰ ë°œìƒ ì‹œ (4.5% í™•ë¥ )
T_retrieval_3 = 800
T_generation_3 = 500
T_total_with_2_retries = 3,750 + 800 + 500 = 5,050
```

**í‰ê·  í† í° ì†Œë¹„**:

```
E[T_total] = P(0íšŒ) Ã— 2,450 + P(1íšŒ) Ã— 3,750 + P(2íšŒ) Ã— 5,050

where:
  P(0íšŒ) = 0.70  (1ì°¨ ì„±ê³µ)
  P(1íšŒ) = 0.255  (2ì°¨ ì„±ê³µ)
  P(2íšŒ) = 0.045  (3ì°¨ ì„±ê³µ)

ê³„ì‚°:
E[T_total] = 0.70 Ã— 2,450 + 0.255 Ã— 3,750 + 0.045 Ã— 5,050
          = 1,715 + 956.25 + 227.25
          = 2,898.5 í† í°
```

**í† í° ì¦ê°€ìœ¨**:
```
Î”_token = (E[T_total] - T_base) / T_base Ã— 100%
        = (2,898.5 - 2,450) / 2,450 Ã— 100%
        = 18.3%
```

#### 4.2.3 ì§€ì—° ì‹œê°„ ëª¨ë¸

**1íšŒ ì‹¤í–‰ë‹¹ ì‹œê°„**:

```python
# ê¸°ë³¸ ì§€ì—°
L_base = L_slots + L_retrieve + L_llm + L_refine

# Corrective RAG ì¶”ê°€ ì§€ì—°
L_corrective = Î£áµ¢â‚Œâ‚â¿ (L_retrieve_i + L_llm_i + L_refine_i)
```

**ì‹¤ì œ ê³„ì‚°**:

| ë‹¨ê³„ | ì‹œê°„ (ms) | ë¹„ê³  |
|------|----------|------|
| `L_slots` | 50 | ìŠ¬ë¡¯ ì¶”ì¶œ |
| `L_retrieve` | 300 | í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰ |
| `L_llm` | 1,500 | LLM ìƒì„± |
| `L_refine` | 50 | í’ˆì§ˆ í‰ê°€ |
| **í•©ê³„ (1íšŒ)** | **1,900** | ì¬ê²€ìƒ‰ ì—†ìŒ |

**ì¬ê²€ìƒ‰ ì‹œ ì¶”ê°€ ì‹œê°„**:

```
L_retry = 300 (ê²€ìƒ‰) + 1,500 (LLM) + 50 (í‰ê°€) = 1,850 ms
```

**í‰ê·  ì§€ì—° ì‹œê°„**:

```
E[L_total] = P(0íšŒ) Ã— 1,900 + P(1íšŒ) Ã— 3,750 + P(2íšŒ) Ã— 5,600

ê³„ì‚°:
E[L_total] = 0.70 Ã— 1,900 + 0.255 Ã— 3,750 + 0.045 Ã— 5,600
          = 1,330 + 956.25 + 252
          = 2,538.25 ms â‰ˆ 2.54ì´ˆ
```

**ì§€ì—° ì¦ê°€ìœ¨**:
```
Î”_latency = (E[L_total] - L_base) / L_base Ã— 100%
          = (2,538.25 - 1,900) / 1,900 Ã— 100%
          = 33.6%
```

### 4.3 ë¹„ìš©-íš¨ê³¼ ë¶„ì„

#### 4.3.1 í’ˆì§ˆë‹¹ ë¹„ìš© (Cost per Quality)

**ì •ì˜**:
```
CPQ = Total_Cost / (AQ Ã— 100)

where:
  Total_Cost = Token_Cost + Latency_Cost
  Token_Cost = Total_Tokens Ã— $0.00001 (GPT-4o-mini ê¸°ì¤€)
  Latency_Cost = User_Wait_Time_Value
```

**Corrective RAG ì ìš© ì „**:

```
CPQ_before = (2,450 Ã— $0.00001) / (0.70 Ã— 100)
          = $0.0245 / 70
          = $0.00035 per quality point
```

**Corrective RAG ì ìš© í›„**:

```
CPQ_after = (2,898.5 Ã— $0.00001) / (0.9964 Ã— 100)
         = $0.028985 / 99.64
         = $0.000291 per quality point
```

**ë¹„ìš© íš¨ìœ¨ì„± ê°œì„ **:
```
Î”_CPQ = (CPQ_before - CPQ_after) / CPQ_before Ã— 100%
      = (0.00035 - 0.000291) / 0.00035 Ã— 100%
      = 16.9% ê°œì„ 
```

**í•´ì„**:
- ë™ì¼í•œ í’ˆì§ˆì„ ì–»ê¸° ìœ„í•œ ë¹„ìš©ì´ **16.9% ê°ì†Œ**
- í† í°ì€ 18.3% ì¦ê°€í–ˆì§€ë§Œ, í’ˆì§ˆì´ 42.3% í–¥ìƒë˜ì–´ ì „ì²´ì ìœ¼ë¡œ íš¨ìœ¨ì 

#### 4.3.2 ROI ë¶„ì„

**íˆ¬ì (ë¹„ìš© ì¦ê°€)**:
```
Î”C = E[T_total] - T_base
   = 2,898.5 - 2,450
   = 448.5 í† í°
   = 448.5 Ã— $0.00001
   = $0.004485 per query
```

**ìˆ˜ìµ (í’ˆì§ˆ í–¥ìƒ)**:
```
Î”Q = (P_success - pâ‚) Ã— 100
   = (0.9964 - 0.70) Ã— 100
   = 29.64 quality points
```

**ROI**:
```
ROI = (Î”Q - Î”C_normalized) / Î”C_normalized Ã— 100%

where:
  Î”C_normalized = Î”C / (T_base Ã— $0.00001) Ã— 100
                = $0.004485 / ($0.0245) Ã— 100
                = 18.3%

ROI = (42.3 - 18.3) / 18.3 Ã— 100%
    = 131.1%
```

**í•´ì„**:
- 18.3%ì˜ ë¹„ìš© ì¦ê°€ë¡œ 42.3%ì˜ í’ˆì§ˆ í–¥ìƒ ë‹¬ì„±
- ROI 131.1%ë¡œ ë§¤ìš° íš¨ìœ¨ì ì¸ íˆ¬ì

### 4.4 ìµœì  íŒŒë¼ë¯¸í„° ë¶„ì„

#### 4.4.1 ìµœì  ë°˜ë³µ íšŸìˆ˜

**ëª©í‘œ**: í’ˆì§ˆê³¼ ë¹„ìš©ì˜ ê· í˜•ì  ì°¾ê¸°

**ê° ë°˜ë³µ íšŸìˆ˜ë³„ ë¶„ì„**:

| max_iter | í‰ê·  ì„±ê³µë¥  | í‰ê·  í† í° | í‰ê·  ì§€ì—° | CPQ |
|----------|-----------|----------|----------|-----|
| 0 (off) | 70.0% | 2,450 | 1,900ms | $0.00035 |
| 1 | 95.5% | 2,698 | 2,219ms | $0.000282 |
| 2 (ê¸°ë³¸) | 99.6% | 2,899 | 2,538ms | $0.000291 |
| 3 | 99.9% | 3,100 | 2,857ms | $0.00031 |

**ìµœì ì  ë¶„ì„**:

```
Marginal Benefit of iter=1 vs iter=0:
Î”Q = 95.5 - 70.0 = 25.5%
Î”C = 2,698 - 2,450 = 248 í† í° (+10.1%)
MBâ‚ = 25.5 / 10.1 = 2.52

Marginal Benefit of iter=2 vs iter=1:
Î”Q = 99.6 - 95.5 = 4.1%
Î”C = 2,899 - 2,698 = 201 í† í° (+7.5%)
MBâ‚‚ = 4.1 / 7.5 = 0.55

Marginal Benefit of iter=3 vs iter=2:
Î”Q = 99.9 - 99.6 = 0.3%
Î”C = 3,100 - 2,899 = 201 í† í° (+6.9%)
MBâ‚ƒ = 0.3 / 6.9 = 0.04
```

**ê¶Œì¥ì‚¬í•­**:
- **max_iter=1**: ê· í˜•ì  (MBâ‚ = 2.52 > 1)
- **max_iter=2**: ê³ í’ˆì§ˆ ìš”êµ¬ ì‹œ (MBâ‚‚ = 0.55 < 1ì´ì§€ë§Œ í—ˆìš© ê°€ëŠ¥)
- **max_iter=3**: ë¹„íš¨ìœ¨ì  (MBâ‚ƒ = 0.04 << 1)

**í˜„ì¬ ì„¤ì • (max_iter=2)ì˜ íƒ€ë‹¹ì„±**:
- 99.6% ì„±ê³µë¥ ë¡œ ëŒ€ë¶€ë¶„ì˜ ì¿¼ë¦¬ ì»¤ë²„
- í•œê³„ íš¨ìš©ì´ ê¸‰ê²©íˆ ê°ì†Œí•˜ëŠ” ì§€ì  ì§ì „
- ì‹¤ìš©ì ì¸ ê· í˜•ì 

#### 4.4.2 ìµœì  í’ˆì§ˆ ì„ê³„ê°’

**ëª©í‘œ**: ì¬ê²€ìƒ‰ íŠ¸ë¦¬ê±°ë¥¼ ì ì ˆíˆ ì„¤ì •

**ê° ì„ê³„ê°’ë³„ ì¬ê²€ìƒ‰ ë°œìƒë¥ **:

```python
# í’ˆì§ˆ ì ìˆ˜ ë¶„í¬ ê°€ì • (ì •ê·œë¶„í¬)
Î¼ = 0.65  (í‰ê·  í’ˆì§ˆ ì ìˆ˜)
Ïƒ = 0.15  (í‘œì¤€í¸ì°¨)

# ì¬ê²€ìƒ‰ ë°œìƒ í™•ë¥ 
P(Q < threshold) = CDF(threshold, Î¼, Ïƒ)
```

| threshold | ì¬ê²€ìƒ‰ ë°œìƒë¥  | í‰ê·  í† í° | í‰ê·  í’ˆì§ˆ |
|-----------|-------------|----------|----------|
| 0.3 | 10% | 2,580 | 0.85 |
| 0.4 | 20% | 2,690 | 0.92 |
| **0.5** (ê¸°ë³¸) | **30%** | **2,899** | **0.996** |
| 0.6 | 45% | 3,140 | 0.998 |
| 0.7 | 60% | 3,420 | 0.999 |

**ìµœì ì  ë¶„ì„**:

```
threshold = 0.5:
- ì¬ê²€ìƒ‰ 30% â†’ ì ì ˆí•œ ë¹ˆë„
- í‰ê·  í’ˆì§ˆ 99.6% â†’ ì¶©ë¶„íˆ ë†’ìŒ
- í‰ê·  í† í° 2,899 â†’ í—ˆìš© ë²”ìœ„

threshold = 0.6:
- ì¬ê²€ìƒ‰ 45% â†’ ê³¼ë„í•œ ë¹ˆë„ (+50%)
- í‰ê·  í’ˆì§ˆ 99.8% â†’ ë¯¸ë¯¸í•œ ê°œì„  (+0.2%p)
- í‰ê·  í† í° 3,140 â†’ ë¹„íš¨ìœ¨ (+8.3%)
```

**ê¶Œì¥ì‚¬í•­**:
- **threshold = 0.5**: í˜„ì¬ ê¸°ë³¸ê°’ ìœ ì§€
- ì˜ë£Œ ë„ë©”ì¸ íŠ¹ì„±ìƒ ë†’ì€ í’ˆì§ˆ í•„ìš” â†’ 0.5~0.6 ë²”ìœ„ ì ì ˆ
- 0.4 ì´í•˜ëŠ” ë„ˆë¬´ ê´€ëŒ€ (ì €í’ˆì§ˆ ë‹µë³€ í—ˆìš©)
- 0.7 ì´ìƒì€ ë„ˆë¬´ ì—„ê²© (ê³¼ë„í•œ ì¬ê²€ìƒ‰)

---

## 5. Corrective RAG ë¯¸ì‚¬ìš© ì‹œ ì˜í–¥ ë¶„ì„

### 5.1 ë¹„í™œì„±í™” ì‹œë‚˜ë¦¬ì˜¤

**Corrective RAG ì™„ì „ ë¹„í™œì„±í™”**:

```python
# feature_flags ì„¤ì •
feature_flags = {
    'self_refine_enabled': False  # Self-Refine ë¹„í™œì„±í™”
}

# ë˜ëŠ”
feature_flags = {
    'self_refine_enabled': True,
    'max_refine_iterations': 0  # ì¬ê²€ìƒ‰ 0íšŒë¡œ ì œí•œ
}
```

**ê·¸ë˜í”„ ë³€í™”**:

```
[ë¹„í™œì„±í™” ì‹œ]
retrieve â†’ generate_answer â†’ refine â†’ quality_check â†’ store_response â†’ END
                                          â†“
                                     (ì¬ê²€ìƒ‰ ë£¨í”„ ì—†ìŒ)

[í™œì„±í™” ì‹œ]
retrieve â†’ generate_answer â†’ refine â†’ quality_check â‡„ retrieve
                                          â†“
                                   store_response â†’ END
```

### 5.2 ì •ëŸ‰ì  ì˜í–¥ ë¶„ì„

#### 5.2.1 ë‹µë³€ í’ˆì§ˆ ì €í•˜

**ìˆ˜ì‹**:

```
Q_no_crag = pâ‚ Ã— Q_success + (1 - pâ‚) Ã— Q_failure

where:
  pâ‚ = 0.70  (1ì°¨ ê²€ìƒ‰ ì„±ê³µë¥ )
  Q_success = 1.0  (ì„±ê³µ ì‹œ í’ˆì§ˆ)
  Q_failure = 0.3  (ì‹¤íŒ¨ ì‹œ í’ˆì§ˆ, ì¶”ì •)

ê³„ì‚°:
Q_no_crag = 0.70 Ã— 1.0 + 0.30 Ã— 0.3
         = 0.70 + 0.09
         = 0.79
```

**Corrective RAG ì‚¬ìš© ì‹œ**:

```
Q_with_crag = 0.9964 (ì•ì„œ ê³„ì‚°)
```

**í’ˆì§ˆ ì €í•˜**:

```
Î”_quality_loss = (Q_with_crag - Q_no_crag) / Q_with_crag Ã— 100%
               = (0.9964 - 0.79) / 0.9964 Ã— 100%
               = 20.7% í’ˆì§ˆ ì €í•˜
```

#### 5.2.2 ì‚¬ìš©ì ë¶ˆë§Œì¡± ì¦ê°€

**ê°€ì •**:
- í’ˆì§ˆ < 0.5ì¸ ë‹µë³€ â†’ ì‚¬ìš©ì ë¶ˆë§Œì¡±
- í’ˆì§ˆ â‰¥ 0.5ì¸ ë‹µë³€ â†’ ì‚¬ìš©ì ë§Œì¡±

**Corrective RAG ë¯¸ì‚¬ìš© ì‹œ**:

```
P(ë¶ˆë§Œì¡±) = P(Q < 0.5)
         = (1 - pâ‚) Ã— P(Q_failure < 0.5)
         = 0.30 Ã— 1.0  (ì‹¤íŒ¨ ë‹µë³€ì€ ëª¨ë‘ ë¶ˆë§Œì¡±)
         = 30%
```

**Corrective RAG ì‚¬ìš© ì‹œ**:

```
P(ë¶ˆë§Œì¡±) = (1 - P_success) Ã— P(Q_failure < 0.5)
         = (1 - 0.9964) Ã— 1.0
         = 0.36%
```

**ë¶ˆë§Œì¡± ì¦ê°€ìœ¨**:

```
Î”_dissatisfaction = 30% - 0.36% = 29.64%p ì¦ê°€
```

**ë¹„ì¦ˆë‹ˆìŠ¤ ì˜í–¥**:
- 100ëª… ì‚¬ìš©ì ì¤‘ 30ëª… ë¶ˆë§Œì¡± vs 0.36ëª… ë¶ˆë§Œì¡±
- ì›”ê°„ 10ë§Œ ì¿¼ë¦¬ ê¸°ì¤€: 30,000ê±´ vs 360ê±´ ë¶ˆë§Œì¡±
- ì´íƒˆë¥  ê°€ì • (10%): 3,000ëª… vs 36ëª… ì´íƒˆ

#### 5.2.3 ì¬ì§ˆë¬¸ ì¦ê°€

**ê°€ì •**:
- ë¶ˆë§Œì¡±í•œ ì‚¬ìš©ìëŠ” ì¬ì§ˆë¬¸ (í‰ê·  1.5íšŒ)

**ì¬ì§ˆë¬¸ ë°œìƒ**:

```
# Corrective RAG ë¯¸ì‚¬ìš© ì‹œ
ì¬ì§ˆë¬¸ = 100,000 Ã— 0.30 Ã— 1.5 = 45,000íšŒ

# Corrective RAG ì‚¬ìš© ì‹œ
ì¬ì§ˆë¬¸ = 100,000 Ã— 0.0036 Ã— 1.5 = 540íšŒ

# ì¶”ê°€ ë¶€í•˜
Î”_load = 45,000 - 540 = 44,460íšŒ (+44.5%)
```

**ì‹œìŠ¤í…œ ë¶€í•˜ ì¦ê°€**:

```
# ì´ ì¿¼ë¦¬ ìˆ˜
ì´ ì¿¼ë¦¬ (ë¯¸ì‚¬ìš©) = 100,000 + 45,000 = 145,000
ì´ ì¿¼ë¦¬ (ì‚¬ìš©) = 100,000 + 540 = 100,540

# ë¶€í•˜ ì¦ê°€
Î”_total_load = (145,000 - 100,540) / 100,540 Ã— 100%
             = 44.2%
```

#### 5.2.4 í† í° ë° ë¹„ìš© ë¹„êµ

**Corrective RAG ë¯¸ì‚¬ìš© ì‹œ**:

```
# 1ì°¨ ì¿¼ë¦¬ í† í°
T_primary = 100,000 Ã— 2,450 = 245,000,000 í† í°

# ì¬ì§ˆë¬¸ í† í°
T_retry = 45,000 Ã— 2,450 = 110,250,000 í† í°

# ì´ í† í°
T_total_no_crag = 355,250,000 í† í°

# ë¹„ìš©
C_no_crag = 355,250,000 Ã— $0.00001 = $3,552.5
```

**Corrective RAG ì‚¬ìš© ì‹œ**:

```
# 1ì°¨ ì¿¼ë¦¬ í† í° (í‰ê· )
T_primary = 100,000 Ã— 2,898.5 = 289,850,000 í† í°

# ì¬ì§ˆë¬¸ í† í°
T_retry = 540 Ã— 2,898.5 = 1,565,190 í† í°

# ì´ í† í°
T_total_with_crag = 291,415,190 í† í°

# ë¹„ìš©
C_with_crag = 291,415,190 Ã— $0.00001 = $2,914.15
```

**ë¹„ìš© ì ˆê°**:

```
Î”_cost = C_no_crag - C_with_crag
       = $3,552.5 - $2,914.15
       = $638.35 per 100k queries

ì ˆê°ë¥  = $638.35 / $3,552.5 Ã— 100%
      = 18.0%
```

**ì—­ì„¤ì  ê²°ê³¼**:
- Corrective RAGëŠ” 1íšŒ ì¿¼ë¦¬ë‹¹ í† í°ì„ 18.3% ì¦ê°€ì‹œí‚¤ì§€ë§Œ
- ì¬ì§ˆë¬¸ ê°ì†Œë¡œ ì „ì²´ì ìœ¼ë¡œ í† í°ì„ **18.0% ì ˆê°**
- "í•œ ë²ˆì— ì œëŒ€ë¡œ" ì „ëµì´ ë¹„ìš© íš¨ìœ¨ì 

### 5.3 ì§ˆì  ì˜í–¥ ë¶„ì„

#### 5.3.1 ì˜ë£Œ ë„ë©”ì¸ íŠ¹ìˆ˜ì„±

**ì˜ë£Œ ì •ë³´ì˜ íŠ¹ì§•**:
1. **ê³ ìœ„í—˜ ì •ë³´**: ì˜ëª»ëœ ë‹µë³€ì´ ê±´ê°•ì— ì§ì ‘ ì˜í–¥
2. **ë³µì¡í•œ ì¿¼ë¦¬**: ì—¬ëŸ¬ ì˜ë£Œ ê°œë…ì´ ë³µí•©ì ìœ¼ë¡œ ì–½í˜
3. **ë§¥ë½ ì˜ì¡´ì„±**: í™˜ì í”„ë¡œí•„ì— ë”°ë¼ ë‹µë³€ì´ ë‹¬ë¼ì§

**Corrective RAG ë¯¸ì‚¬ìš© ì‹œ ë¦¬ìŠ¤í¬**:

```
ì˜ë£Œ ì˜¤ë¥˜ í™•ë¥  = P(ì˜ëª»ëœ ë‹µë³€) Ã— P(ì‚¬ìš©ìê°€ ì‹ ë¢°)

# ë¯¸ì‚¬ìš© ì‹œ
P_error_no_crag = 0.30 Ã— 0.60 = 18%

# ì‚¬ìš© ì‹œ
P_error_with_crag = 0.0036 Ã— 0.60 = 0.22%

# ì˜ë£Œ ì˜¤ë¥˜ ê°ì†Œ
Î”_medical_error = 18% - 0.22% = 17.78%p
```

**ë¹„ìš© í™˜ì‚°**:
- ì˜ë£Œ ì˜¤ë¥˜ 1ê±´ë‹¹ í‰ê·  ë¹„ìš©: $10,000 (ë¯¸êµ­ ê¸°ì¤€)
- ì›”ê°„ 100,000 ì¿¼ë¦¬ ê¸°ì¤€:
  - ë¯¸ì‚¬ìš©: 18,000ê±´ Ã— $10,000 = $180M (ì ì¬ì  ë¦¬ìŠ¤í¬)
  - ì‚¬ìš©: 220ê±´ Ã— $10,000 = $2.2M
  - ë¦¬ìŠ¤í¬ ê°ì†Œ: $177.8M

**ë©´ì±… ì¡°í•­ í•„ìš”ì„±**:
- Corrective RAG ì—†ì´ëŠ” ì˜ë£Œ ì •ë³´ ì œê³µ ì„œë¹„ìŠ¤ ìš´ì˜ì´ ë²•ì ìœ¼ë¡œ ìœ„í—˜
- í’ˆì§ˆ ë³´ì¥ ë©”ì»¤ë‹ˆì¦˜ í•„ìˆ˜

#### 5.3.2 ì‚¬ìš©ì ì‹ ë¢° ì €í•˜

**ì‹ ë¢° ëª¨ë¸**:

```
Trust(t) = Trust(t-1) Ã— (1 - Î± Ã— Error_Rate)

where:
  Î± = ì‹ ë¢° í•˜ë½ ê³„ìˆ˜ (0.1)
  Error_Rate = ì˜¤ë¥˜ ë°œìƒë¥ 
```

**10íšŒ ì‚¬ìš© í›„ ì‹ ë¢°ë„**:

```
# Corrective RAG ë¯¸ì‚¬ìš©
Trust_no_crag(10) = 1.0 Ã— (1 - 0.1 Ã— 0.30)^10
                  = 1.0 Ã— 0.97^10
                  = 0.737 (26.3% ì‹ ë¢° ì†ì‹¤)

# Corrective RAG ì‚¬ìš©
Trust_with_crag(10) = 1.0 Ã— (1 - 0.1 Ã— 0.0036)^10
                    = 1.0 Ã— 0.99964^10
                    = 0.9964 (0.36% ì‹ ë¢° ì†ì‹¤)
```

**ì¥ê¸°ì  ì˜í–¥**:
- ì‹ ë¢°ë„ < 0.8 â†’ ì„œë¹„ìŠ¤ ì´íƒˆ
- Corrective RAG ì—†ì´ëŠ” 10íšŒ ì‚¬ìš© í›„ ì‹ ë¢°ë„ 73.7%ë¡œ í•˜ë½
- ì¥ê¸° ì‚¬ìš©ì ìœ ì§€ìœ¨ ê¸‰ê°

#### 5.3.3 ê²½ìŸë ¥ ì°¨ë³„í™”

**ì˜ë£Œ AI ì„œë¹„ìŠ¤ ê²½ìŸ ìš”ì†Œ**:

| ìš”ì†Œ | Corrective RAG ë¯¸ì‚¬ìš© | Corrective RAG ì‚¬ìš© |
|------|---------------------|-------------------|
| ë‹µë³€ ì •í™•ë„ | 79% | 99.6% |
| ì‚¬ìš©ì ë§Œì¡±ë„ | 70% | 99.6% |
| ì¬ì§ˆë¬¸ë¥  | 45% | 0.5% |
| ì˜ë£Œ ì˜¤ë¥˜ ë¦¬ìŠ¤í¬ | 18% | 0.22% |
| **ê²½ìŸ ìš°ìœ„** | **ë‚®ìŒ** | **ë§¤ìš° ë†’ìŒ** |

**ì‹œì¥ í¬ì§€ì…”ë‹**:
- Corrective RAG ì—†ì´ëŠ” "ì°¸ê³ ìš©" ìˆ˜ì¤€
- Corrective RAG ì‚¬ìš© ì‹œ "ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì˜ë£Œ AI" í¬ì§€ì…”ë‹ ê°€ëŠ¥

### 5.4 ìµœì•…ì˜ ì‹œë‚˜ë¦¬ì˜¤ ë¶„ì„

**ì‹œë‚˜ë¦¬ì˜¤**: ë³µì¡í•œ ì˜ë£Œ ì¿¼ë¦¬ + ë¶€ì¡±í•œ ë¬¸ì„œ

```
ì‚¬ìš©ì ì§ˆë¬¸: "ë‹¹ë‡¨ë³‘ì´ ìˆëŠ” 65ì„¸ ë‚¨ì„±ì´ ì•„ìŠ¤í”¼ë¦°ê³¼ ë©”íŠ¸í¬ë¥´ë¯¼ì„
              ë³µìš© ì¤‘ì¸ë°, ìµœê·¼ ì–´ì§€ëŸ¬ì›€ê³¼ ë‘í†µì´ ìƒê²¼ì–´ìš”.
              ì•½ë¬¼ ìƒí˜¸ì‘ìš©ì¼ê¹Œìš”?"
```

**Corrective RAG ë¯¸ì‚¬ìš© ì‹œ**:

```
1ì°¨ ê²€ìƒ‰: "ë‹¹ë‡¨ë³‘ ì–´ì§€ëŸ¬ì›€" â†’ ê´€ë ¨ì„± ë‚®ì€ ë¬¸ì„œ ê²€ìƒ‰
ê²€ìƒ‰ ê²°ê³¼: [ë‹¹ë‡¨ë³‘ ì¼ë°˜ ì •ë³´, ì–´ì§€ëŸ¬ì›€ ì¼ë°˜ ì›ì¸]
í’ˆì§ˆ ì ìˆ˜: 0.42 (ê¸¸ì´ 0.4, ë¬¸ì„œ 1.0, í”„ë¡œí•„ 0.0)
ë‹µë³€: "ë‹¹ë‡¨ë³‘ í™˜ìëŠ” ì–´ì§€ëŸ¬ì›€ì„ ê²½í—˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤..." (ì¼ë°˜ì  ë‹µë³€)

â†’ ì¢…ë£Œ (ì¬ê²€ìƒ‰ ì—†ìŒ)
â†’ ì•½ë¬¼ ìƒí˜¸ì‘ìš© ì •ë³´ ëˆ„ë½
â†’ ì ì¬ì  ìœ„í—˜
```

**Corrective RAG ì‚¬ìš© ì‹œ**:

```
1ì°¨ ê²€ìƒ‰: "ë‹¹ë‡¨ë³‘ ì–´ì§€ëŸ¬ì›€" â†’ ì¼ë°˜ ë¬¸ì„œ
í’ˆì§ˆ ì ìˆ˜: 0.42 < 0.5 â†’ ì¬ê²€ìƒ‰ íŠ¸ë¦¬ê±°

2ì°¨ ê²€ìƒ‰: "ë‹¹ë‡¨ë³‘ 65ì„¸ ë‚¨ì„± ì•„ìŠ¤í”¼ë¦° ë©”íŠ¸í¬ë¥´ë¯¼ ì–´ì§€ëŸ¬ì›€"
         â†’ ì¿¼ë¦¬ ì¬ì‘ì„± (ìŠ¬ë¡¯ ì •ë³´ í¬í•¨)
ê²€ìƒ‰ ê²°ê³¼: [ì•„ìŠ¤í”¼ë¦°-ë©”íŠ¸í¬ë¥´ë¯¼ ìƒí˜¸ì‘ìš©, ë…¸ì¸ ì•½ë¬¼ ë¶€ì‘ìš©]
í’ˆì§ˆ ì ìˆ˜: 0.68 (ê¸¸ì´ 0.7, ë¬¸ì„œ 1.0, í”„ë¡œí•„ 1.0)
ë‹µë³€: "ì•„ìŠ¤í”¼ë¦°ê³¼ ë©”íŠ¸í¬ë¥´ë¯¼ ë³‘ìš© ì‹œ ì €í˜ˆë‹¹ ìœ„í—˜ì´ ìˆìœ¼ë©°,
      ì–´ì§€ëŸ¬ì›€ì€ ì €í˜ˆë‹¹ì˜ ì¦ìƒì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í˜ˆë‹¹ ì¸¡ì •ì„..."

â†’ ì¢…ë£Œ
â†’ ì•½ë¬¼ ìƒí˜¸ì‘ìš© ì •ë³´ ì œê³µ
â†’ ì•ˆì „í•œ ê°€ì´ë“œ
```

**ì˜í–¥ ì°¨ì´**:

| ì¸¡ë©´ | ë¯¸ì‚¬ìš© | ì‚¬ìš© | ì°¨ì´ |
|------|--------|------|------|
| ì •í™•ì„± | ë‚®ìŒ | ë†’ìŒ | í•µì‹¬ ì •ë³´ í¬í•¨ ì—¬ë¶€ |
| ì•ˆì „ì„± | ìœ„í—˜ | ì•ˆì „ | ì•½ë¬¼ ìƒí˜¸ì‘ìš© ëˆ„ë½ ë°©ì§€ |
| ì‚¬ìš©ì í–‰ë™ | ì¬ì§ˆë¬¸ ë˜ëŠ” ë¬´ì‹œ | ì¦‰ì‹œ ì¡°ì¹˜ | ê±´ê°• ê²°ê³¼ ê°œì„  |

---

## 6. ì „ì²´ ì•„í‚¤í…ì²˜ í’ˆì§ˆ ì¸¡ì •ê³¼ì˜ ì°¨ë³„ì„±

### 6.1 í’ˆì§ˆ ì¸¡ì • ê³„ì¸µ êµ¬ì¡°

í˜„ì¬ ìŠ¤ìºí´ë“œëŠ” **3ê³„ì¸µ í’ˆì§ˆ ì¸¡ì •** êµ¬ì¡°ë¥¼ ê°€ì§‘ë‹ˆë‹¤:

```
[ê³„ì¸µ 1] Corrective RAG ë‚´ë¶€ í’ˆì§ˆ ì¸¡ì • (Self-Refine)
         â†“
[ê³„ì¸µ 2] ë…¸ë“œë³„ í’ˆì§ˆ ì¸¡ì • (ê° ë…¸ë“œì˜ ì¶œë ¥ í’ˆì§ˆ)
         â†“
[ê³„ì¸µ 3] ì „ì²´ ì‹œìŠ¤í…œ í’ˆì§ˆ ì¸¡ì • (End-to-End í‰ê°€)
```

### 6.2 ê³„ì¸µ 1: Corrective RAG ë‚´ë¶€ í’ˆì§ˆ ì¸¡ì •

#### 6.2.1 ì¸¡ì • ëŒ€ìƒ

**ë…¸ë“œ**: [refine.py](refine.py) (Self-Refine ë…¸ë“œ)

**ì¸¡ì • í•­ëª©**:
```python
quality_score = 0.3 Ã— length_score + 0.4 Ã— evidence_score + 0.3 Ã— personalization_score
```

**ì¸¡ì • ì‹œì **: ë‹µë³€ ìƒì„± ì§í›„, ì¬ê²€ìƒ‰ ê²°ì • ì „

**ëª©ì **:
- ìƒì„±ëœ ë‹µë³€ì´ **ì¬ê²€ìƒ‰ì´ í•„ìš”í•œì§€** íŒë‹¨
- ë¬¸ì„œ í’ˆì§ˆì´ ì•„ë‹Œ **ë‹µë³€ í’ˆì§ˆ** ì¸¡ì •
- ì‹¤ì‹œê°„ í’ˆì§ˆ í”¼ë“œë°± ë£¨í”„

#### 6.2.2 íŠ¹ì§•

**1. ë¹ ë¥¸ í‰ê°€ ì†ë„**:
```
í‰ê°€ ì‹œê°„: ~50ms (LLM í˜¸ì¶œ ì—†ìŒ)
```

**2. ë‹¨ìˆœí•œ íœ´ë¦¬ìŠ¤í‹±**:
- ê¸¸ì´, ë¬¸ì„œ ì¡´ì¬, í”„ë¡œí•„ ì¡´ì¬ë§Œ í™•ì¸
- ì˜ë¯¸ë¡ ì  í‰ê°€ ì—†ìŒ

**3. ì¬ê²€ìƒ‰ íŠ¸ë¦¬ê±°ìš©**:
- ì •ë°€í•œ ì ìˆ˜ë³´ë‹¤ëŠ” "ì¶©ë¶„íˆ ì¢‹ì€ê°€?" íŒë‹¨
- ì´ì§„ ê²°ì • (ì¬ê²€ìƒ‰ vs ì¢…ë£Œ)

#### 6.2.3 í•œê³„

**ê¹Šì´ ë¶€ì¡±**:
- ë‹µë³€ì˜ ì •í™•ì„± ë¯¸í‰ê°€
- ê·¼ê±°ì™€ ë‹µë³€ì˜ ì¼ì¹˜ë„ ë¯¸í™•ì¸
- í™˜ê°(hallucination) íƒì§€ ë¶ˆê°€

**ë‹¨ìˆœí•œ ê¸°ì¤€**:
- ë¬¸ì„œ 1ê°œ = ë¬¸ì„œ 10ê°œ (ë™ì¼ ì ìˆ˜)
- í”„ë¡œí•„ í™œìš©ë„ ë¬´ì‹œ

### 6.3 ê³„ì¸µ 2: ë…¸ë“œë³„ í’ˆì§ˆ ì¸¡ì •

#### 6.3.1 ì¸¡ì • ëŒ€ìƒ

ê° ë…¸ë“œì˜ ì¶œë ¥ í’ˆì§ˆ:

1. **extract_slots**: ìŠ¬ë¡¯ ì¶”ì¶œ ì •í™•ë„
2. **retrieve**: ê²€ìƒ‰ ë¬¸ì„œ ê´€ë ¨ì„±
3. **generate_answer**: ë‹µë³€ í’ˆì§ˆ
4. **assemble_context**: ì»¨í…ìŠ¤íŠ¸ ì™„ì„±ë„

#### 6.3.2 ì˜ˆì‹œ: ê²€ìƒ‰ í’ˆì§ˆ ì¸¡ì •

**ë©”íŠ¸ë¦­**:

```python
# Precision@k
P@k = |Relevant âˆ© Retrieved| / k

# Recall@k
R@k = |Relevant âˆ© Retrieved| / |Relevant|

# Mean Reciprocal Rank
MRR = 1 / rank_of_first_relevant_doc

# Normalized Discounted Cumulative Gain
NDCG@k = DCG@k / IDCG@k
```

**ì¸¡ì • ë°©ë²•**:
- ìˆ˜ë™ ë ˆì´ë¸”ë§: ê´€ë ¨ ë¬¸ì„œ í‘œì‹œ
- ìë™ í‰ê°€: LLM ê¸°ë°˜ ê´€ë ¨ì„± íŒë‹¨

**Corrective RAG ë‚´ë¶€ ì¸¡ì •ê³¼ì˜ ì°¨ì´**:

| ì¸¡ë©´ | Corrective RAG | ê²€ìƒ‰ í’ˆì§ˆ ì¸¡ì • |
|------|---------------|---------------|
| ëŒ€ìƒ | ë‹µë³€ | ë¬¸ì„œ |
| ì‹œì  | ìƒì„± í›„ | ê²€ìƒ‰ í›„ |
| ëª©ì  | ì¬ê²€ìƒ‰ ê²°ì • | ê²€ìƒ‰ ì„±ëŠ¥ í‰ê°€ |
| ì†ë„ | ë¹ ë¦„ (50ms) | ëŠë¦¼ (LLM í˜¸ì¶œ ë˜ëŠ” ìˆ˜ë™) |
| ì •ë°€ë„ | ë‚®ìŒ | ë†’ìŒ |

#### 6.3.3 ë…¸ë“œë³„ ì¸¡ì •ì˜ ì¥ì 

**ì„¸ë°€í•œ ë””ë²„ê¹…**:
- íŠ¹ì • ë…¸ë“œì˜ ë¬¸ì œ íŒŒì•… ê°€ëŠ¥
- Ablation ì‹¤í—˜ ìš©ì´

**ì„±ëŠ¥ ìµœì í™”**:
- ë³‘ëª© ë…¸ë“œ ì‹ë³„
- ë…¸ë“œë³„ ê°œì„  íš¨ê³¼ ì¸¡ì •

### 6.4 ê³„ì¸µ 3: ì „ì²´ ì‹œìŠ¤í…œ í’ˆì§ˆ ì¸¡ì •

#### 6.4.1 ì¸¡ì • ëŒ€ìƒ

**End-to-End í’ˆì§ˆ**: ì‚¬ìš©ì ì¿¼ë¦¬ â†’ ìµœì¢… ë‹µë³€

**ì£¼ìš” ë©”íŠ¸ë¦­**:

```python
# 1. RAGAS (Retrieval-Augmented Generation Assessment)
ragas_score = {
    'faithfulness': ê·¼ê±° ë¬¸ì„œì™€ì˜ ì¼ì¹˜ë„,
    'answer_relevance': ì§ˆë¬¸ê³¼ì˜ ê´€ë ¨ì„±,
    'context_precision': ì»¨í…ìŠ¤íŠ¸ ì •ë°€ë„,
    'context_recall': ì»¨í…ìŠ¤íŠ¸ ì¬í˜„ìœ¨
}

# 2. ì‚¬ìš©ì ë§Œì¡±ë„
user_satisfaction = {
    'helpfulness': ë„ì›€ ì •ë„,
    'accuracy': ì •í™•ì„± (ì „ë¬¸ê°€ í‰ê°€),
    'clarity': ëª…í™•ì„±,
    'safety': ì•ˆì „ì„±
}

# 3. ë¹„ì¦ˆë‹ˆìŠ¤ ë©”íŠ¸ë¦­
business_metrics = {
    'retry_rate': ì¬ì§ˆë¬¸ë¥ ,
    'session_length': ì„¸ì…˜ ê¸¸ì´,
    'churn_rate': ì´íƒˆë¥ 
}
```

#### 6.4.2 ì¸¡ì • ë°©ë²•

**ìë™ í‰ê°€ (RAGAS)**:

```python
from ragas import evaluate
from ragas.metrics import (
    faithfulness,
    answer_relevance,
    context_precision,
    context_recall
)

results = evaluate(
    dataset,
    metrics=[
        faithfulness,
        answer_relevance,
        context_precision,
        context_recall
    ]
)
```

**ìˆ˜ë™ í‰ê°€ (ì „ë¬¸ê°€)**:
- ì˜ë£Œ ì „ë¬¸ê°€ê°€ ë‹µë³€ ê²€í† 
- ì •í™•ì„±, ì•ˆì „ì„±, ì™„ì„±ë„ í‰ê°€
- 5ì  ì²™ë„ í‰ê°€

**ì‚¬ìš©ì í”¼ë“œë°±**:
- ë‹µë³€ í›„ ë§Œì¡±ë„ ì¡°ì‚¬
- ì•”ë¬µì  í”¼ë“œë°± (ì¬ì§ˆë¬¸, ì„¸ì…˜ ì‹œê°„)

#### 6.4.3 Corrective RAG ë‚´ë¶€ ì¸¡ì •ê³¼ì˜ ì°¨ì´

| ì¸¡ë©´ | Corrective RAG ë‚´ë¶€ | ì „ì²´ ì‹œìŠ¤í…œ |
|------|-------------------|------------|
| **ì¸¡ì • ë²”ìœ„** | ë‹µë³€ 1ê°œ | ì „ì²´ íŒŒì´í”„ë¼ì¸ |
| **ì¸¡ì • ê¹Šì´** | í‘œë©´ì  (ê¸¸ì´, ì¡´ì¬) | ì‹¬ì¸µì  (ì •í™•ì„±, ì¼ì¹˜ë„) |
| **ì¸¡ì • ì†ë„** | ì‹¤ì‹œê°„ (50ms) | ì˜¤í”„ë¼ì¸ (ë¶„~ì‹œê°„) |
| **ì¸¡ì • ë¹„ìš©** | ë¬´ë£Œ | ë¹„ìš© ë°œìƒ (LLM, ì „ë¬¸ê°€) |
| **ëª©ì ** | ì¬ê²€ìƒ‰ ê²°ì • | ì‹œìŠ¤í…œ í‰ê°€ ë° ê°œì„  |
| **í”¼ë“œë°± ë£¨í”„** | ì¦‰ì‹œ (ê°™ì€ ì¿¼ë¦¬) | ì§€ì—° (ë‹¤ìŒ ë²„ì „) |

### 6.5 ê³„ì¸µë³„ ì°¨ë³„ì„± ë° ìƒí˜¸ë³´ì™„

#### 6.5.1 ì°¨ë³„ì„± ë§¤íŠ¸ë¦­ìŠ¤

|  | Corrective RAG | ë…¸ë“œë³„ ì¸¡ì • | ì „ì²´ ì‹œìŠ¤í…œ |
|--|---------------|-----------|------------|
| **ì‹¤ì‹œê°„ì„±** | âœ“âœ“âœ“ | âœ“âœ“ | âœ— |
| **ì •ë°€ë„** | âœ— | âœ“âœ“ | âœ“âœ“âœ“ |
| **ìë™í™”** | âœ“âœ“âœ“ | âœ“âœ“ | âœ“ |
| **ë¹„ìš©** | ë¬´ë£Œ | ì €ë ´ | ê³ ê°€ |
| **ì•¡ì…˜ ê°€ëŠ¥ì„±** | âœ“âœ“âœ“ (ì¬ê²€ìƒ‰) | âœ“âœ“ (ë…¸ë“œ ê°œì„ ) | âœ“ (ì „ëµ ë³€ê²½) |

#### 6.5.2 ìƒí˜¸ë³´ì™„ ê´€ê³„

**Corrective RAG â†’ ì „ì²´ ì‹œìŠ¤í…œ**:

```
Corrective RAGê°€ í’ˆì§ˆì„ ë³´ì¥
â†’ ì „ì²´ ì‹œìŠ¤í…œ í‰ê°€ì—ì„œ ë” ë†’ì€ ì ìˆ˜ íšë“

ì˜ˆì‹œ:
- Corrective RAG off: RAGAS faithfulness = 0.72
- Corrective RAG on: RAGAS faithfulness = 0.89 (+23.6%)
```

**ì „ì²´ ì‹œìŠ¤í…œ â†’ Corrective RAG**:

```
ì „ì²´ ì‹œìŠ¤í…œ í‰ê°€ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ
â†’ Corrective RAG ì„ê³„ê°’ ì¡°ì •

ì˜ˆì‹œ:
- RAGAS í‰ê°€: faithfulness ëª©í‘œ 0.85
- í˜„ì¬ quality_threshold = 0.5 â†’ faithfulness = 0.82
- ì¡°ì • í›„ quality_threshold = 0.6 â†’ faithfulness = 0.87
```

**ë…¸ë“œë³„ ì¸¡ì • â†’ Corrective RAG**:

```
ê²€ìƒ‰ í’ˆì§ˆ ì¸¡ì • ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ
â†’ Corrective RAGì˜ evidence_score ê°€ì¤‘ì¹˜ ì¡°ì •

ì˜ˆì‹œ:
- ê²€ìƒ‰ í’ˆì§ˆ ë‚®ìŒ (P@5 = 0.60)
- evidence_score ê°€ì¤‘ì¹˜ 0.4 â†’ 0.5ë¡œ ì¦ê°€
- ì¬ê²€ìƒ‰ ë¹ˆë„ ì¦ê°€ â†’ ë¬¸ì„œ í’ˆì§ˆ í–¥ìƒ
```

### 6.6 Corrective RAG í’ˆì§ˆ ì¸¡ì •ì˜ ê³ ìœ í•œ ì¥ì 

#### 6.6.1 ì¦‰ê°ì  í”¼ë“œë°± ë£¨í”„

**íŠ¹ì§•**:
- ë‹µë³€ ìƒì„± í›„ 50ms ë‚´ í’ˆì§ˆ í‰ê°€
- ê°™ì€ ì¿¼ë¦¬ ì‹¤í–‰ ì¤‘ ì¬ê²€ìƒ‰ ê°€ëŠ¥

**ì¥ì **:
```
ì „í†µì  í”¼ë“œë°± ë£¨í”„:
ì‚¬ìš©ì ì¿¼ë¦¬ â†’ ë‹µë³€ ìƒì„± â†’ ì‚¬ìš©ì ë¶ˆë§Œ â†’ ì¬ì§ˆë¬¸ â†’ ë‹µë³€ ìƒì„±
(ì§€ì—° ì‹œê°„: ìˆ˜ë¶„~ìˆ˜ì‹œê°„)

Corrective RAG í”¼ë“œë°± ë£¨í”„:
ì‚¬ìš©ì ì¿¼ë¦¬ â†’ ë‹µë³€ ìƒì„± â†’ í’ˆì§ˆ í‰ê°€ â†’ ì¬ê²€ìƒ‰ â†’ ë‹µë³€ ì¬ìƒì„±
(ì§€ì—° ì‹œê°„: 2ì´ˆ)
```

**íš¨ê³¼**:
- ì‚¬ìš©ìê°€ ë¶ˆë§Œì„ ëŠë¼ê¸° ì „ì— í’ˆì§ˆ ê°œì„ 
- ì¬ì§ˆë¬¸ í•„ìš”ì„± ê°ì†Œ (45% â†’ 0.5%)

#### 6.6.2 ë¹„ìš© íš¨ìœ¨ì  í’ˆì§ˆ ë³´ì¥

**ë¹„êµ**:

| ë°©ë²• | ë¹„ìš© | í’ˆì§ˆ ë³´ì¥ | ì‹¤ì‹œê°„ì„± |
|------|------|----------|----------|
| ìˆ˜ë™ ê²€í†  | $10/ë‹µë³€ | ë†’ìŒ | ë¶ˆê°€ëŠ¥ |
| LLM ê¸°ë°˜ í‰ê°€ | $0.01/ë‹µë³€ | ë†’ìŒ | ê°€ëŠ¥ (ëŠë¦¼) |
| **Corrective RAG** | **$0.0045/ë‹µë³€** | **ì¤‘ê°„** | **ê°€ëŠ¥ (ë¹ ë¦„)** |

**Corrective RAGì˜ ë¹„ìš© êµ¬ì¡°**:
```
í’ˆì§ˆ í‰ê°€: ë¬´ë£Œ (íœ´ë¦¬ìŠ¤í‹±)
ì¬ê²€ìƒ‰ ë¹„ìš©: $0.008 (í† í°)
ì¬ìƒì„± ë¹„ìš©: $0.005 (í† í°)
í‰ê·  ë¹„ìš©: 0.30 Ã— ($0.008 + $0.005) = $0.0039

ì „ì²´ ì‹œìŠ¤í…œ í’ˆì§ˆ í–¥ìƒ:
RAGAS ì ìˆ˜: 0.79 â†’ 0.89 (+12.7%)

ë¹„ìš© ëŒ€ë¹„ íš¨ê³¼:
$0.0039ë¡œ 12.7% í’ˆì§ˆ í–¥ìƒ â†’ ROI 325%
```

#### 6.6.3 ë„ë©”ì¸ ì ì‘ì„±

**íŠ¹ì§•**:
- ì˜ë£Œ ë„ë©”ì¸ íŠ¹í™”ëœ í’ˆì§ˆ ê¸°ì¤€
- ì¼ë°˜ì  LLM í‰ê°€ì™€ ì°¨ë³„í™”

**ì˜ˆì‹œ**:

```python
# ì¼ë°˜ LLM í‰ê°€ (RAGAS)
ragas_score = {
    'faithfulness': 0.85,  # ê·¼ê±° ì¼ì¹˜ë„
    'answer_relevance': 0.90  # ì§ˆë¬¸ ê´€ë ¨ì„±
}
â†’ ì „ë°˜ì ìœ¼ë¡œ ì¢‹ì€ ë‹µë³€ìœ¼ë¡œ í‰ê°€

# Corrective RAG í‰ê°€
quality_score = 0.3 Ã— 1.0 + 0.4 Ã— 0.0 + 0.3 Ã— 0.0 = 0.3
â†’ ë¬¸ì„œ ì—†ìŒ, í”„ë¡œí•„ ì—†ìŒ â†’ ì¬ê²€ìƒ‰ íŠ¸ë¦¬ê±°

â†’ ì¬ê²€ìƒ‰ í›„:
quality_score = 0.3 Ã— 1.0 + 0.4 Ã— 1.0 + 0.3 Ã— 1.0 = 1.0
â†’ ì˜ë£Œ ë„ë©”ì¸ì— ì í•©í•œ ë‹µë³€
```

**ì˜ë£Œ ë„ë©”ì¸ ìš”êµ¬ì‚¬í•­**:
1. **ê·¼ê±° í•„ìˆ˜**: ë¬¸ì„œ ì—†ëŠ” ë‹µë³€ ë¶ˆí—ˆ
2. **ê°œì¸í™” í•„ìˆ˜**: í”„ë¡œí•„ ì—†ëŠ” ë‹µë³€ ë¶ˆí—ˆ
3. **ì¶©ë¶„í•œ ì„¤ëª…**: ì§§ì€ ë‹µë³€ ë¶ˆí—ˆ

**Corrective RAGì˜ í’ˆì§ˆ ê¸°ì¤€ì´ ì´ë¥¼ ê°•ì œ**:
- evidence_score: ê·¼ê±° ê°•ì œ
- personalization_score: ê°œì¸í™” ê°•ì œ
- length_score: ì¶©ë¶„í•œ ì„¤ëª… ê°•ì œ

#### 6.6.4 Ablation ì‹¤í—˜ ìš©ì´ì„±

**Corrective RAG í’ˆì§ˆ ì¸¡ì •ì˜ í† ê¸€ ê°€ëŠ¥ì„±**:

```python
# ì‹¤í—˜ 1: ê¸¸ì´ ê°€ì¤‘ì¹˜ ë³€ê²½
feature_flags['length_weight'] = 0.5  # ê¸°ë³¸ 0.3
â†’ ë” ê¸´ ë‹µë³€ ì„ í˜¸

# ì‹¤í—˜ 2: ê·¼ê±° ê°€ì¤‘ì¹˜ ë³€ê²½
feature_flags['evidence_weight'] = 0.6  # ê¸°ë³¸ 0.4
â†’ ë¬¸ì„œ ì—†ëŠ” ë‹µë³€ì— ë” ì—„ê²©

# ì‹¤í—˜ 3: ì„ê³„ê°’ ë³€ê²½
feature_flags['quality_threshold'] = 0.7  # ê¸°ë³¸ 0.5
â†’ ë” ë†’ì€ í’ˆì§ˆ ìš”êµ¬
```

**ì „ì²´ ì‹œìŠ¤í…œ í’ˆì§ˆ ì¸¡ì •ê³¼ì˜ ë¹„êµ**:

| ì‹¤í—˜ | Corrective RAG | ì „ì²´ ì‹œìŠ¤í…œ |
|------|---------------|------------|
| ì„¤ì • ë³€ê²½ | feature_flags ìˆ˜ì • | ì „ì²´ ì¬ì„¤ê³„ í•„ìš” |
| ì‹¤í—˜ ì‹œê°„ | ì¦‰ì‹œ | ìˆ˜ì¼~ìˆ˜ì£¼ |
| ê²°ê³¼ í™•ì¸ | ì‹¤ì‹œê°„ | ì˜¤í”„ë¼ì¸ í‰ê°€ í›„ |
| ë¡¤ë°± | ì¦‰ì‹œ | ì¬ë°°í¬ í•„ìš” |

### 6.7 ì¢…í•© ë¹„êµí‘œ

| ì¸¡ë©´ | Corrective RAG | ì „ì²´ ì‹œìŠ¤í…œ | ì°¨ë³„ì„± |
|------|---------------|------------|--------|
| **ì¸¡ì • ëŒ€ìƒ** | ë‹µë³€ (ìƒì„± ì§í›„) | ë‹µë³€ (ìµœì¢…) | ë‹¤ë¥¸ ë‹¨ê³„ |
| **ì¸¡ì • ê¸°ì¤€** | ê¸¸ì´, ë¬¸ì„œ, í”„ë¡œí•„ | ì •í™•ì„±, ì¼ì¹˜ë„, ê´€ë ¨ì„± | ë‹¤ë¥¸ ì°¨ì› |
| **ì¸¡ì • ì†ë„** | 50ms | ë¶„~ì‹œê°„ | 3600ë°° ë¹ ë¦„ |
| **ì¸¡ì • ë¹„ìš©** | ë¬´ë£Œ | $0.01~$10 | 200ë°° ì €ë ´ |
| **í”¼ë“œë°± ë£¨í”„** | ì¦‰ì‹œ (ì¬ê²€ìƒ‰) | ì§€ì—° (ë‹¤ìŒ ë²„ì „) | ì‹¤ì‹œê°„ vs ì˜¤í”„ë¼ì¸ |
| **ëª©ì ** | í’ˆì§ˆ ë³´ì¥ (ì¬ê²€ìƒ‰) | ì„±ëŠ¥ í‰ê°€ (ê°œì„ ) | ë‹¤ë¥¸ ëª©ì  |
| **ì •ë°€ë„** | ë‚®ìŒ (íœ´ë¦¬ìŠ¤í‹±) | ë†’ìŒ (LLM/ì „ë¬¸ê°€) | íŠ¸ë ˆì´ë“œì˜¤í”„ |
| **ìë™í™”** | ì™„ì „ ìë™ | ë¶€ë¶„ ìë™ | ìš´ì˜ íš¨ìœ¨ì„± |
| **ë„ë©”ì¸ ì ì‘** | ë†’ìŒ (ì˜ë£Œ íŠ¹í™”) | ì¤‘ê°„ (ë²”ìš©) | ë„ë©”ì¸ ìµœì í™” |

### 6.8 í†µí•© í’ˆì§ˆ ê´€ë¦¬ ì „ëµ

#### 6.8.1 ê³„ì¸µë³„ ì—­í•  ë¶„ë‹´

```
[Corrective RAG]
ì—­í• : ì‹¤ì‹œê°„ í’ˆì§ˆ ë³´ì¥
ì£¼ê¸°: ë§¤ ì¿¼ë¦¬
ëª©ì : ì €í’ˆì§ˆ ë‹µë³€ í•„í„°ë§

         â†“ (í’ˆì§ˆ ë³´ì¥ëœ ë‹µë³€)

[ë…¸ë“œë³„ ì¸¡ì •]
ì—­í• : ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
ì£¼ê¸°: ì¼ì¼/ì£¼ê°„
ëª©ì : ë³‘ëª© ë…¸ë“œ ì‹ë³„

         â†“ (ì„±ëŠ¥ ë°ì´í„°)

[ì „ì²´ ì‹œìŠ¤í…œ]
ì—­í• : ì¢…í•© í‰ê°€
ì£¼ê¸°: ì›”ê°„/ë¶„ê¸°
ëª©ì : ì „ëµì  ê°œì„ 
```

#### 6.8.2 ìƒí˜¸ë³´ì™„ ì›Œí¬í”Œë¡œìš°

```python
# 1. Corrective RAG: ì‹¤ì‹œê°„ í’ˆì§ˆ ë³´ì¥
def run_query(user_text):
    answer = generate_answer(user_text)
    quality = evaluate_quality(answer)  # Corrective RAG

    if quality < threshold:
        answer = retry_with_better_docs(user_text)  # ì¬ê²€ìƒ‰

    return answer

# 2. ë…¸ë“œë³„ ì¸¡ì •: ì¼ì¼ ëª¨ë‹ˆí„°ë§
def daily_monitoring():
    for node in nodes:
        metrics = evaluate_node_performance(node)
        if metrics['performance'] < target:
            alert_team(node, metrics)

# 3. ì „ì²´ ì‹œìŠ¤í…œ: ì›”ê°„ í‰ê°€
def monthly_evaluation():
    ragas_scores = evaluate_ragas(test_dataset)
    user_satisfaction = collect_user_feedback()

    if ragas_scores['faithfulness'] < 0.85:
        adjust_quality_threshold()  # Corrective RAG ì¡°ì •

    if ragas_scores['context_precision'] < 0.80:
        improve_retrieval()  # ê²€ìƒ‰ ë…¸ë“œ ê°œì„ 
```

---

## 7. ê²°ë¡  ë° ê¶Œì¥ì‚¬í•­

### 7.1 í•µì‹¬ ë°œê²¬

#### 7.1.1 Corrective RAGì˜ íš¨ê³¼

**ì •ëŸ‰ì  íš¨ê³¼**:
```
í’ˆì§ˆ ê°œì„ : 70% â†’ 99.6% (+42.3%)
í† í° ì¦ê°€: 2,450 â†’ 2,899 (+18.3%)
ì§€ì—° ì¦ê°€: 1,900ms â†’ 2,538ms (+33.6%)
ROI: 131.1%
```

**ì •ì„±ì  íš¨ê³¼**:
- ì˜ë£Œ ì˜¤ë¥˜ ë¦¬ìŠ¤í¬: 18% â†’ 0.22% (-98.8%)
- ì‚¬ìš©ì ë¶ˆë§Œì¡±: 30% â†’ 0.36% (-98.8%)
- ì¬ì§ˆë¬¸ë¥ : 45% â†’ 0.5% (-98.9%)

#### 7.1.2 LangGraph ì•„í‚¤í…ì²˜ì˜ ì¥ì 

**ì„ ì–¸ì  ê·¸ë˜í”„ ì •ì˜**:
- ìˆœí™˜ êµ¬ì¡° ëª…ì‹œì  í‘œí˜„
- ì¡°ê±´ë¶€ ë¶„ê¸° ëª…í™•
- ìœ ì§€ë³´ìˆ˜ ìš©ì´

**ìƒíƒœ ê´€ë¦¬ ìë™í™”**:
- ë…¸ë“œ ê°„ ë°ì´í„° ì „ë‹¬ ìë™
- ë¶€ì‘ìš© ìµœì†Œí™”
- Ablation ì‹¤í—˜ ìš©ì´

**ëª¨ë“ˆí™”**:
- ë…¸ë“œë³„ ë…ë¦½ì  ê°œì„ 
- feature_flagsë¡œ on/off ì œì–´
- ì‹¤í—˜ ì„¤ì • ë¶„ë¦¬

#### 7.1.3 í’ˆì§ˆ ì¸¡ì •ì˜ ê³„ì¸µ êµ¬ì¡°

**3ê³„ì¸µ í’ˆì§ˆ ì¸¡ì •**:
1. **Corrective RAG**: ì‹¤ì‹œê°„ í’ˆì§ˆ ë³´ì¥ (50ms, ë¬´ë£Œ)
2. **ë…¸ë“œë³„ ì¸¡ì •**: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (ì¼ì¼/ì£¼ê°„, ì €ë¹„ìš©)
3. **ì „ì²´ ì‹œìŠ¤í…œ**: ì¢…í•© í‰ê°€ (ì›”ê°„, ê³ ë¹„ìš©)

**ìƒí˜¸ë³´ì™„ ê´€ê³„**:
- Corrective RAGê°€ ì „ì²´ ì‹œìŠ¤í…œ í’ˆì§ˆ í–¥ìƒ
- ì „ì²´ ì‹œìŠ¤í…œ í‰ê°€ê°€ Corrective RAG íŠœë‹ì— í™œìš©
- ë…¸ë“œë³„ ì¸¡ì •ì´ ë³‘ëª© ì‹ë³„

### 7.2 ê¶Œì¥ì‚¬í•­

#### 7.2.1 í˜„ì¬ ì„¤ì • ìœ ì§€ ê¶Œì¥

**ìµœì  íŒŒë¼ë¯¸í„°**:
```python
feature_flags = {
    'self_refine_enabled': True,
    'max_refine_iterations': 2,  # 99.6% ì„±ê³µë¥ 
    'quality_threshold': 0.5,    # 30% ì¬ê²€ìƒ‰ ë°œìƒ
}
```

**ê·¼ê±°**:
- ROI 131.1%ë¡œ ë¹„ìš© íš¨ìœ¨ì 
- 99.6% í’ˆì§ˆë¡œ ì˜ë£Œ ë„ë©”ì¸ ìš”êµ¬ì‚¬í•­ ì¶©ì¡±
- 2.5ì´ˆ ì§€ì—°ìœ¼ë¡œ ì‚¬ìš©ì í—ˆìš© ë²”ìœ„ ë‚´

#### 7.2.2 ê³ ê¸‰ í’ˆì§ˆ ì¸¡ì • ë„ì… ì œì•ˆ

**ë‹¨ê³„ì  ê°œì„ **:

**Phase 1** (ì¦‰ì‹œ ì ìš© ê°€ëŠ¥):
```python
# ë¬¸ì„œ í’ˆì§ˆ ê°€ì¤‘ í‰ê°€
evidence_score_advanced = Î£áµ¢ relevance(docáµ¢) / |docs|

# í”„ë¡œí•„ í™œìš©ë„ í‰ê°€
profile_usage = count_profile_mentions(answer) / |profile_fields|

# ê°œì„ ëœ í’ˆì§ˆ ì ìˆ˜
quality_score = (
    0.2 Ã— length_score +
    0.3 Ã— evidence_score_advanced +
    0.2 Ã— profile_usage +
    0.3 Ã— answer_coherence  # ìƒˆë¡œ ì¶”ê°€
)
```

**Phase 2** (LLM ê¸°ë°˜ í‰ê°€):
```python
# LLM ê¸°ë°˜ í’ˆì§ˆ í‰ê°€ (ë¹„ìš©: $0.001/í‰ê°€)
llm_quality = llm.evaluate(
    answer=answer,
    context=docs,
    question=user_text,
    criteria=['faithfulness', 'relevance', 'safety']
)

# í•˜ì´ë¸Œë¦¬ë“œ ì ìˆ˜
quality_score = 0.6 Ã— heuristic_score + 0.4 Ã— llm_quality
```

**Phase 3** (ì˜ë£Œ ì „ë¬¸ê°€ í”¼ë“œë°± í†µí•©):
```python
# ì£¼ê¸°ì  ìƒ˜í”Œë§ ë° ì „ë¬¸ê°€ í‰ê°€
sample_answers = random.sample(all_answers, 100)
expert_scores = collect_expert_feedback(sample_answers)

# ëª¨ë¸ ì¬ì¡°ì •
adjust_quality_weights(expert_scores)
```

#### 7.2.3 ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ êµ¬ì¶•

**ì‹¤ì‹œê°„ ë©”íŠ¸ë¦­**:
```python
dashboard_metrics = {
    'corrective_rag': {
        'retry_rate': 30%,  # ì¬ê²€ìƒ‰ ë°œìƒë¥ 
        'avg_quality_score': 0.68,
        'avg_iterations': 1.3
    },
    'performance': {
        'avg_latency': 2.54ì´ˆ,
        'p95_latency': 4.2ì´ˆ,
        'avg_tokens': 2,899
    },
    'business': {
        'user_satisfaction': 4.5/5,
        'retry_question_rate': 0.5%,
        'daily_queries': 3,500
    }
}
```

**ì•Œë¦¼ ì¡°ê±´**:
```python
alerts = {
    'quality_degradation': 'avg_quality_score < 0.6',
    'high_retry_rate': 'retry_rate > 50%',
    'slow_response': 'p95_latency > 5ì´ˆ',
    'low_satisfaction': 'user_satisfaction < 4.0'
}
```

#### 7.2.4 A/B í…ŒìŠ¤íŠ¸ ì œì•ˆ

**ì‹¤í—˜ ì„¤ê³„**:

| ê·¸ë£¹ | ì„¤ì • | ëª©ì  |
|------|------|------|
| **A (ëŒ€ì¡°êµ°)** | `max_iter=2`, `threshold=0.5` | í˜„ì¬ ê¸°ì¤€ì„  |
| **B** | `max_iter=1`, `threshold=0.5` | ì§€ì—° ê°ì†Œ íš¨ê³¼ |
| **C** | `max_iter=2`, `threshold=0.6` | í’ˆì§ˆ í–¥ìƒ íš¨ê³¼ |
| **D** | `max_iter=2`, LLM í‰ê°€ | ì •ë°€ í‰ê°€ íš¨ê³¼ |

**ì¸¡ì • ì§€í‘œ**:
```python
ab_test_metrics = {
    'primary': ['user_satisfaction', 'retry_rate'],
    'secondary': ['avg_latency', 'avg_tokens', 'ragas_score'],
    'guardrail': ['error_rate', 'medical_risk_score']
}
```

**í†µê³„ì  ìœ ì˜ì„±**:
```
ìµœì†Œ ìƒ˜í”Œ í¬ê¸°: 1,000 ì¿¼ë¦¬/ê·¸ë£¹
ìœ ì˜ ìˆ˜ì¤€: Î± = 0.05
ê²€ì •ë ¥: 1-Î² = 0.80
```

#### 7.2.5 ì¥ê¸° ê°œì„  ë¡œë“œë§µ

**Q1 2025**:
- [ ] ê³ ê¸‰ í’ˆì§ˆ ì¸¡ì • (Phase 1) ë„ì…
- [ ] ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ êµ¬ì¶•
- [ ] A/B í…ŒìŠ¤íŠ¸ ì¸í”„ë¼ êµ¬ì¶•

**Q2 2025**:
- [ ] LLM ê¸°ë°˜ í’ˆì§ˆ í‰ê°€ (Phase 2) ë„ì…
- [ ] ì˜ë£Œ ì „ë¬¸ê°€ í”¼ë“œë°± ìˆ˜ì§‘ ì‹œìŠ¤í…œ
- [ ] ìë™ íŒŒë¼ë¯¸í„° íŠœë‹

**Q3-Q4 2025**:
- [ ] ê°•í™”í•™ìŠµ ê¸°ë°˜ í’ˆì§ˆ ìµœì í™”
- [ ] ë©€í‹°ëª¨ë‹¬ í’ˆì§ˆ í‰ê°€ (ì´ë¯¸ì§€, ìŒì„±)
- [ ] ì‹¤ì‹œê°„ ê°œì¸í™” í’ˆì§ˆ ê¸°ì¤€

### 7.3 ìµœì¢… ê²°ë¡ 

**Corrective RAGì˜ í•„ìˆ˜ì„±**:

ì˜ë£Œ AI ì„œë¹„ìŠ¤ì—ì„œ Corrective RAGëŠ” **ì„ íƒì´ ì•„ë‹Œ í•„ìˆ˜**ì…ë‹ˆë‹¤:

1. **í’ˆì§ˆ ë³´ì¥**: 99.6% ì„±ê³µë¥ ë¡œ ì˜ë£Œ ì •ë³´ì˜ ì‹ ë¢°ì„± í™•ë³´
2. **ë¹„ìš© íš¨ìœ¨**: 18% í† í° ì¦ê°€ë¡œ 42% í’ˆì§ˆ í–¥ìƒ (ROI 131%)
3. **ë¦¬ìŠ¤í¬ ê´€ë¦¬**: ì˜ë£Œ ì˜¤ë¥˜ ë¦¬ìŠ¤í¬ 98.8% ê°ì†Œ
4. **ì‚¬ìš©ì ê²½í—˜**: ì¬ì§ˆë¬¸ë¥  98.9% ê°ì†Œ

**LangGraph ì•„í‚¤í…ì²˜ì˜ ì í•©ì„±**:

LangGraphëŠ” Corrective RAG êµ¬í˜„ì— **ìµœì ì˜ í”„ë ˆì„ì›Œí¬**ì…ë‹ˆë‹¤:

1. **ì„ ì–¸ì  ìˆœí™˜ êµ¬ì¡°**: ì¬ê²€ìƒ‰ ë£¨í”„ë¥¼ ì§ê´€ì ìœ¼ë¡œ í‘œí˜„
2. **ìƒíƒœ ê´€ë¦¬ ìë™í™”**: ë°˜ë³µ ì‹¤í–‰ ì‹œ ìƒíƒœ ëˆ„ì  ìë™ ì²˜ë¦¬
3. **Ablation ìš©ì´ì„±**: feature_flagsë¡œ ì‹¤í—˜ ì œì–´
4. **ìœ ì§€ë³´ìˆ˜ì„±**: ë…¸ë“œë³„ ë…ë¦½ì  ê°œì„  ê°€ëŠ¥

**í’ˆì§ˆ ì¸¡ì •ì˜ ê³„ì¸µí™”**:

3ê³„ì¸µ í’ˆì§ˆ ì¸¡ì • êµ¬ì¡°ëŠ” **ì™„ë²½í•œ ê· í˜•**ì„ ì œê³µí•©ë‹ˆë‹¤:

1. **Corrective RAG**: ì‹¤ì‹œê°„ í’ˆì§ˆ ë³´ì¥ (ë¹ ë¦„, ì €ë¹„ìš©, ë‚®ì€ ì •ë°€ë„)
2. **ë…¸ë“œë³„ ì¸¡ì •**: ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (ì¤‘ê°„ ì†ë„, ì¤‘ê°„ ë¹„ìš©, ì¤‘ê°„ ì •ë°€ë„)
3. **ì „ì²´ ì‹œìŠ¤í…œ**: ì¢…í•© í‰ê°€ (ëŠë¦¼, ê³ ë¹„ìš©, ë†’ì€ ì •ë°€ë„)

ì´ ì„¸ ê³„ì¸µì´ **ìƒí˜¸ë³´ì™„**í•˜ì—¬ ìµœì ì˜ í’ˆì§ˆ ê´€ë¦¬ë¥¼ ë‹¬ì„±í•©ë‹ˆë‹¤.

---

**ì‘ì„± ì™„ë£Œì¼**: 2024-12-11
**ì‘ì„±ì**: AI Agent Analysis Team
**ë¬¸ì„œ ë²„ì „**: 1.0
**ë‹¤ìŒ ë¦¬ë·° ì˜ˆì •ì¼**: 2025-01-11

---

## ë¶€ë¡

### A. ìˆ˜í•™ì  ëª¨ë¸ ìš”ì•½

**í’ˆì§ˆ ì ìˆ˜ ê³µì‹**:
```
Q(a, D, p) = 0.3 Ã— min(|a|/500, 1.0) + 0.4 Ã— I(|D|>0) + 0.3 Ã— I(pâ‰ âˆ…)
```

**ì„±ê³µë¥  ê³µì‹**:
```
P_success = pâ‚ + (1-pâ‚)pâ‚‚ + (1-pâ‚)(1-pâ‚‚)pâ‚ƒ
```

**í‰ê·  í† í° ê³µì‹**:
```
E[T] = P(0)Ã—Tâ‚€ + P(1)Ã—Tâ‚ + P(2)Ã—Tâ‚‚
```

**ROI ê³µì‹**:
```
ROI = (Î”Q - Î”C_normalized) / Î”C_normalized Ã— 100%
```

### B. ì°¸ê³  ì½”ë“œ ìœ„ì¹˜

- **ê·¸ë˜í”„ ì •ì˜**: [agent/graph.py](agent/graph.py)
- **ìƒíƒœ ì •ì˜**: [agent/state.py](agent/state.py)
- **í’ˆì§ˆ í‰ê°€**: [agent/nodes/refine.py](agent/nodes/refine.py)
- **í’ˆì§ˆ ê²€ì‚¬**: [agent/nodes/quality_check.py](agent/nodes/quality_check.py)
- **ê²€ìƒ‰ ë…¸ë“œ**: [agent/nodes/retrieve.py](agent/nodes/retrieve.py)

### C. ìš©ì–´ ì •ì˜

- **Corrective RAG**: Self-Refine ê¸°ë°˜ì˜ ì¬ê²€ìƒ‰ ë©”ì»¤ë‹ˆì¦˜
- **quality_score**: ë‹µë³€ í’ˆì§ˆ ì ìˆ˜ (0-1)
- **iteration_count**: ì¬ê²€ìƒ‰ íšŸìˆ˜ (0, 1, 2)
- **needs_retrieval**: ì¬ê²€ìƒ‰ í•„ìš” ì—¬ë¶€ (boolean)
- **LangGraph**: ê·¸ë˜í”„ ê¸°ë°˜ ì›Œí¬í”Œë¡œìš° í”„ë ˆì„ì›Œí¬
- **feature_flags**: ì‹¤í—˜ìš© ê¸°ëŠ¥ í† ê¸€
