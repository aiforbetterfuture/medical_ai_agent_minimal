# 멀티턴 컨텍스트 최소 개선 작업 보고서 (쉬운 설명)

## 무엇을 바꿨나요?
1. **토큰/컨텍스트 매니저 추가 (`context/`)**
   - `TokenManager`: 전체 프롬프트 길이를 나눠 쓸 예산표를 만듭니다.
   - `ContextManager`: 예산표에 맞춰 프로필, 최근 대화, 장기 요약을 깔끔하게 합칩니다.

2. **상태(AgentState) 확장**
   - 세션/사용자 ID, 컨텍스트 프롬프트, 토큰 예산 정보 등을 담을 칸을 새로 만들었습니다.

3. **assemble_context 노드 개선**
   - TokenManager/ContextManager를 불러서, 토큰 예산 안에서 대화 맥락을 자동으로 정리해 `context_prompt`에 저장합니다.

4. **generate_answer 노드 개선**
   - LLM에 보낼 최종 사용자 프롬프트 앞에 `context_prompt`를 붙여, 정리된 맥락을 그대로 전달합니다.

## 왜 좋은가요?
- **토큰 절약**: 길어진 대화도 핵심만 추려서 넣어, 불필요한 토큰 낭비를 줄입니다.
- **맥락 유지**: 최근 대화/프로필 요약을 구조적으로 전달해 “말이 이어지는” 답을 얻기 쉽습니다.
- **안정성**: 기존 7-노드 구조는 그대로 두고, 옵션처럼 얹어 무결성을 해치지 않습니다.

## 기대 효과 (쉬운 비유)
- 예산 노트(TokenManager)를 만들어 “얼마나 적을지” 정해 놓고,
- 컨텍스트 정리봇(ContextManager)이 그 예산 안에서 중요한 말만 추립니다.
- 그래서 LLM에게는 “압축 정리본 + 현재 질문”만 보내 시간을 아끼고, 실수도 줄입니다.

## 공학적 우수성 포인트
- **모듈화**: 토큰/컨텍스트 로직을 별도 모듈로 분리해 유지보수 용이.
- **호환성**: 기존 LangGraph 플로우·ProfileStore·하이브리드 검색을 건드리지 않음.
- **확장성**: 나중에 실제 토크나이저(tiktoken)나 장기 저장소(DB)를 붙이기 쉬운 인터페이스.

## 앞으로 바로 해볼 추가 한 가지
- `assemble_context`에서 생성된 `token_plan.for_docs`를 `retrieve` 노드의 k 값 조정에 활용하면, 검색 길이도 예산에 맞춰 더 줄일 수 있습니다.

