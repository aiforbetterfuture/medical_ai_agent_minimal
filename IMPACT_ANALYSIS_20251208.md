# 변경 영향 및 발전 가능성 분석 (2025-12-08)

본 문서는 CRAG 내부 루프와 LangGraph 외부 루프를 분리/플래그화하고, 동적 RAG 라우팅·질의 재작성·메모리 ablation·MedCAT2 on/off 실험 지원을 추가한 최신 수정의 기대효과, 차별점, 발전 가능성을 정리한다. 수정 전/후 비교와 수정 이유를 포함한다.

---

## 1. 주요 변경 요약
- 기능 플래그 추가: `self_refine_enabled`, `max_refine_iterations`, `dynamic_rag_routing`, `medcat2_enabled`, `memory_mode`, `query_rewrite_enabled`, `top_k`.
- 질의 재작성: 슬롯·프로필을 반영해 검색 질의를 재구성.
- 질문 유형별 라우팅: 증상/질환→symptom, 약물→medication, 기타→default 인덱스.
- 메모리 모드 분리: 구조화 슬롯 메모리 vs 미사용(`none`) ablation.
- 멀티턴 벤치마크 스크립트: 플래그별 on/off 성능 비교 자동화.
- 문서 보강: 내부(마이크로 루프) vs 외부(매크로 플로우) 차이를 명시.

---

## 2. 수정 전/후 비교

| 항목 | 수정 전 | 수정 후 | 수정 이유 |
| --- | --- | --- | --- |
| 내부/외부 루프 구분 | 코드상 암묵적, on/off 불가 | 플래그로 on/off·반복횟수 제어 | 심사 피드백: 구현 차이·목적 불명확 → 실험 가능하게 분리 |
| RAG 라우팅 | 단일 경로 | 증상/약물/기본 라우팅 | 컨텍스트 엔지니어링 요구: 문서 선택 동적 활용 근거 마련 |
| 질의 재작성 | 원문 그대로 검색 | 슬롯·프로필 포함 재작성 | 개인화·금기 반영, 히트율·사실성 개선 의도 |
| 메모리 | 항상 사용 | `structured`/`none` 선택 | 메모리 기여도 ablation 요구 대응 |
| MedCAT2 | 기본 on, 제어 불가 | 플래그로 on/off | 사용자 정보 수집 기여도 비교 요구 대응 |
| 평가 | 마지막 턴 중심 사례 | 멀티턴 벤치 스크립트, 플래그별 pass-rate | 멀티턴 전 구간 비교 필요성 해소 |
| 문서화 | 다이어그램만 | 내부/외부 루프 역할·플래그를 문서화 | 심사 질문 사전 차단, 구현 근거 명시 |

---

## 3. 기대효과 (기술·공학적)
- **가시성**: 내부/외부 루프가 분리되어 품질 보정(마이크로) vs 세션 관리(매크로)가 명확해짐.
- **실험성**: 플래그로 ablation 실행→ 성능/안전/비용 트레이드오프를 표로 제시 가능.
- **사실성·개인화**: 질의 재작성+라우팅으로 관련 문서 hit-rate 상승 기대, 개인화 정보 반영률 개선.
- **안전성**: 메모리/MedCAT2 on/off 실험으로 금기 안내·환각률 변화를 수치화 가능.
- **재현성**: 멀티턴 벤치 스크립트로 동일 설정 재실행이 가능, 논문 검증 용이.

---

## 4. 차별점 (수정 후 기준)
- CRAG 마이크로 루프와 LangGraph 매크로 플로우를 기능 플래그로 구분하여 “내부 품질 보정 vs 외부 컨텍스트 관리”를 실험적으로 보여줄 수 있음.
- 슬롯 기반 라우팅 + 질의 재작성의 결합으로 RAG 파이프라인이 사용자 정보와 질문 유형에 적응.
- 메모리·MedCAT2·셀프 리파인·라우팅을 각각 on/off하여 기여도를 정량 비교할 수 있는 구조.
- 멀티턴 벤치마크가 내장되어 논문 피드백(마지막 턴만 비교) 문제를 직접 해소.

---

## 5. 발전 가능성 / 후속 과제
- **정량 평가 고도화**: pass-rate 외에 근거 매칭 점수, 안전 필터 적중률, 길이 안정성 등을 로그로 추가.
- **라우팅 학습화**: 규칙 기반 라우팅을 소프트 라우터(LLM/분류기)로 대체, 실패 사례 자동 보정.
- **쿼리 재작성 품질**: LLM 기반 재작성 모델/프롬프트 최적화 및 실패 시 폴백 로직 추가.
- **메모리 압축**: 긴 세션에서 요약 메모리 옵션 추가하여 비용/지연 절감.
- **비용 제어**: self_refine off + top_k 조절로 비용-성능 커브를 실험/보고.
- **데이터셋 확장**: 실제 사용자 로그 기반 멀티턴 시나리오 추가, MedQA 등 공개 벤치로 단일턴 보조 비교.

---

## 6. 심사 대응 포인트 (왜 이렇게 수정했는가)
- “CRAG 내부 순환 vs LangGraph 외부 순환 차이가 불명확” → 플래그와 문서로 역할 분리 + ablation 가능.
- “멀티턴 비교가 마지막 턴만” → 멀티턴 벤치 스크립트로 전 턴 평가 및 pass-rate 제시.
- “사용자 정보 수집/동적 문서 활용/메모리 구현·비교 부재” → MedCAT2 on/off, 라우팅 on/off, 메모리 on/off, self_refine on/off를 모두 실험 가능한 구조로 전환.

---

## 7. 사용 가이드 (요약)
- 플래그 override 예: `python -m evaluation.multiturn_benchmark --limit 30 --disable-self-refine --memory-mode none --disable-routing`
- run_agent 멀티턴: `state = run_agent(..., return_state=True)`로 받은 상태를 다음 턴 `session_state`로 재사용.
- 문서 참조: `ARCHITECTURE_DIAGRAMS.md` 섹션 “CRAG 내부 루프 vs LangGraph 외부 루프”에서 코드 위치와 플래그 설명 확인.

