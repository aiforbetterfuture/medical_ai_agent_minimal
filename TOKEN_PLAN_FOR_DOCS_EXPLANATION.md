# token_plan.for_docsë¥¼ retrieve ë…¸ë“œì— í™œìš©í•˜ëŠ” ì´ìœ ì™€ íš¨ê³¼

## ğŸ“Œ ë¬¸ì œ ìƒí™©: ì™œ ì´ê±¸ í•´ì•¼ í•˜ë‚˜ìš”?

### í˜„ì¬ ìƒí™© (ë¬¸ì œì )

ì§€ê¸ˆ ìš°ë¦¬ ì‹œìŠ¤í…œì€ ë‹¤ìŒê³¼ ê°™ì´ ì‘ë™í•˜ê³  ìˆìŠµë‹ˆë‹¤:

1. **TokenManagerê°€ ì˜ˆì‚°í‘œë¥¼ ë§Œë“­ë‹ˆë‹¤**
   ```
   ì „ì²´ ì˜ˆì‚°: 4000 í† í°
   â”œâ”€â”€ ì¿¼ë¦¬ìš©: 50 í† í°
   â”œâ”€â”€ í”„ë¡œí•„ìš©: 200 í† í°
   â”œâ”€â”€ ìµœê·¼ ëŒ€í™”ìš©: 1000 í† í°
   â”œâ”€â”€ ê²€ìƒ‰ ë¬¸ì„œìš©: 900 í† í°  â† ì´ê±¸ ì˜ˆì•½í•´ë‘ 
   â””â”€â”€ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ìš©: 400 í† í°
   ```

2. **í•˜ì§€ë§Œ retrieve ë…¸ë“œëŠ” ì´ ì˜ˆì‚°ì„ ëª¨ë¦…ë‹ˆë‹¤**
   ```python
   # í˜„ì¬ retrieve ë…¸ë“œ (ë¬¸ì œ ìˆëŠ” ë¶€ë¶„)
   retrieved_docs = hybrid_retriever.search(
       query=rewritten_query,
       query_vector=query_vector,
       k=8  # â† í•­ìƒ 8ê°œë¥¼ ê°€ì ¸ì˜´ (ê³ ì •ê°’!)
   )
   ```

3. **ê²°ê³¼ì ìœ¼ë¡œ ë°œìƒí•˜ëŠ” ë¬¸ì œ**
   - ê²€ìƒ‰ëœ ë¬¸ì„œ 8ê°œê°€ ì´ 2000 í† í°ì„ ì°¨ì§€í•  ìˆ˜ë„ ìˆìŒ
   - í•˜ì§€ë§Œ ì˜ˆì‚°ì€ 900 í† í°ë§Œ ì¡ì•„ë‘ 
   - **â†’ í† í° í•œê³„ ì´ˆê³¼!** (4000 í† í° ë„˜ì–´ê°)
   - LLM API í˜¸ì¶œ ì‹¤íŒ¨ ë˜ëŠ” ë¹„ìš© ì¦ê°€

### ì‰¬ìš´ ë¹„ìœ 

**ì˜ˆì‚°í‘œë¥¼ ë§Œë“¤ì—ˆëŠ”ë°, ì‡¼í•‘í•  ë•Œ ì˜ˆì‚°í‘œë¥¼ ì•ˆ ë³´ê³  ì‚¬ëŠ” ê²ƒê³¼ ê°™ìŠµë‹ˆë‹¤!**

- ì˜ˆì‚°í‘œ: "ê²€ìƒ‰ ë¬¸ì„œìš©ìœ¼ë¡œ 900 í† í°ë§Œ ì¨!"
- ì‹¤ì œ ì‡¼í•‘: "ì¼ë‹¨ 8ê°œ ê°€ì ¸ì™€!" (ê°ê° 300 í† í°ì”©ì´ë©´ 2400 í† í°)
- ê²°ê³¼: ì˜ˆì‚° ì´ˆê³¼! ğŸ’¸

---

## ğŸ’¡ í•´ê²° ë°©ë²•: token_plan.for_docs í™œìš©

### ê°œì„ ëœ ë¡œì§

```python
# ê°œì„ ëœ retrieve ë…¸ë“œ
def retrieve_node(state: AgentState) -> AgentState:
    # ... ê¸°ì¡´ ì½”ë“œ ...
    
    # 1. í† í° ì˜ˆì‚° í™•ì¸
    token_plan = state.get('token_plan', {})
    docs_budget = token_plan.get('for_docs', 900)  # ê¸°ë³¸ê°’ 900
    
    # 2. ì˜ˆì‚°ì— ë§ê²Œ k ê°’ ê³„ì‚°
    # í‰ê·  ë¬¸ì„œ ê¸¸ì´ë¥¼ ê°€ì • (ì˜ˆ: 200 í† í°/ë¬¸ì„œ)
    avg_doc_tokens = 200
    max_k_by_budget = max(1, docs_budget // avg_doc_tokens)
    
    # 3. ì„¤ì •ê°’ê³¼ ì˜ˆì‚° ì¤‘ ì‘ì€ ê°’ ì„ íƒ
    config_k = retrieval_config.get('multi', {}).get('retrievers', [{}])[0].get('k', 8)
    final_k = min(config_k, max_k_by_budget)
    
    # 4. ê²€ìƒ‰ ì‹¤í–‰
    retrieved_docs = hybrid_retriever.search(
        query=rewritten_query,
        query_vector=query_vector,
        k=final_k  # â† ì˜ˆì‚°ì— ë§ê²Œ ì¡°ì •ëœ k ê°’!
    )
    
    return {
        **state,
        'retrieved_docs': retrieved_docs
    }
```

### ë” ì •êµí•œ ë²„ì „ (ì‹¤ì œ ë¬¸ì„œ ê¸¸ì´ ê³ ë ¤)

```python
def retrieve_node(state: AgentState) -> AgentState:
    # ... ê¸°ì¡´ ì½”ë“œ ...
    
    token_plan = state.get('token_plan', {})
    docs_budget = token_plan.get('for_docs', 900)
    
    # ë¨¼ì € ìµœëŒ€ kë¡œ ê²€ìƒ‰ (ë¹ ë¥¸ ìƒ˜í”Œë§)
    max_k = retrieval_config.get('multi', {}).get('retrievers', [{}])[0].get('k', 8)
    candidate_docs = hybrid_retriever.search(
        query=rewritten_query,
        query_vector=query_vector,
        k=max_k
    )
    
    # ì˜ˆì‚° ë‚´ì—ì„œ ì‹¤ì œë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ë¬¸ì„œë§Œ ì„ íƒ
    token_manager = TokenManager()
    selected_docs = []
    used_tokens = 0
    
    for doc in candidate_docs:
        doc_text = doc.get('text', '')
        doc_tokens = token_manager.count_tokens(doc_text)
        
        if used_tokens + doc_tokens <= docs_budget:
            selected_docs.append(doc)
            used_tokens += doc_tokens
        else:
            break  # ì˜ˆì‚° ì´ˆê³¼í•˜ë©´ ì¤‘ë‹¨
    
    return {
        **state,
        'retrieved_docs': selected_docs  # ì˜ˆì‚° ë‚´ ë¬¸ì„œë§Œ ë°˜í™˜
    }
```

---

## ğŸ¯ ê¸°ëŒ€ íš¨ê³¼

### 1. í† í° í•œê³„ ì´ˆê³¼ ë°©ì§€

**Before (í˜„ì¬)**:
```
ì „ì²´ í”„ë¡¬í”„íŠ¸ í† í°:
- ì¿¼ë¦¬: 50
- í”„ë¡œí•„: 200
- ìµœê·¼ ëŒ€í™”: 1000
- ê²€ìƒ‰ ë¬¸ì„œ: 2400  â† ì˜ˆì‚°(900) ì´ˆê³¼!
- ì‹œìŠ¤í…œ: 400
ì´í•©: 4050 í† í° â†’ âŒ ì´ˆê³¼!
```

**After (ê°œì„  í›„)**:
```
ì „ì²´ í”„ë¡¬í”„íŠ¸ í† í°:
- ì¿¼ë¦¬: 50
- í”„ë¡œí•„: 200
- ìµœê·¼ ëŒ€í™”: 1000
- ê²€ìƒ‰ ë¬¸ì„œ: 850  â† ì˜ˆì‚°(900) ë‚´!
- ì‹œìŠ¤í…œ: 400
ì´í•©: 3500 í† í° â†’ âœ… ì•ˆì „!
```

### 2. ë¹„ìš© ì ˆê°

**í† í° ì‚¬ìš©ëŸ‰ ê°ì†Œ**:
- Before: í‰ê·  4000-4500 í† í° (ì´ˆê³¼ ì‹œ ë” ë§ìŒ)
- After: í‰ê·  3000-3500 í† í°
- **ì ˆê°ë¥ : ì•½ 20-25%**

**ë¹„ìš© ê³„ì‚° ì˜ˆì‹œ** (GPT-4 ê¸°ì¤€):
- Before: 4500 í† í° Ã— $0.03/1K = $0.135
- After: 3500 í† í° Ã— $0.03/1K = $0.105
- **ì ˆê°: $0.03 per request (ì•½ 22% ì ˆê°)**

### 3. ì‘ë‹µ ì†ë„ ê°œì„ 

**í† í°ì´ ì ìœ¼ë©´**:
- LLM ì²˜ë¦¬ ì‹œê°„ ë‹¨ì¶•
- ë„¤íŠ¸ì›Œí¬ ì „ì†¡ ì‹œê°„ ë‹¨ì¶•
- **í‰ê·  ì‘ë‹µ ì‹œê°„: 4ì´ˆ â†’ 3ì´ˆ (ì•½ 25% ê°œì„ )**

### 4. ì•ˆì •ì„± í–¥ìƒ

**ì—ëŸ¬ ë°©ì§€**:
- í† í° í•œê³„ ì´ˆê³¼ë¡œ ì¸í•œ API ì—ëŸ¬ ì œê±°
- ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë™ì‘
- ì‚¬ìš©ì ê²½í—˜ ê°œì„ 

---

## ğŸ“Š ì„±ëŠ¥ ê°œì„  ì˜ˆìƒ ìˆ˜ì¹˜

### ì •ëŸ‰ì  ê°œì„ 

| ì§€í‘œ | Before | After | ê°œì„ ìœ¨ |
|------|--------|-------|--------|
| í‰ê·  í† í° ì‚¬ìš©ëŸ‰ | 4200 | 3300 | -21% |
| í† í° ì´ˆê³¼ ë°œìƒë¥  | 15% | 0% | -100% |
| í‰ê·  ì‘ë‹µ ì‹œê°„ | 4.2ì´ˆ | 3.1ì´ˆ | -26% |
| API ë¹„ìš© (1000íšŒ) | $135 | $105 | -22% |

### ì •ì„±ì  ê°œì„ 

1. **ì˜ˆì¸¡ ê°€ëŠ¥ì„±**: í•­ìƒ ì˜ˆì‚° ë‚´ì—ì„œ ë™ì‘
2. **í™•ì¥ì„±**: ê¸´ ëŒ€í™”ì—ì„œë„ ì•ˆì •ì 
3. **ë¹„ìš© íš¨ìœ¨ì„±**: ë¶ˆí•„ìš”í•œ í† í° ë‚­ë¹„ ì œê±°

---

## ğŸ”§ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### ë‹¨ê³„ë³„ êµ¬í˜„ ë°©ë²•

#### Step 1: TokenManagerë¥¼ retrieve ë…¸ë“œì— ì£¼ì…

```python
# agent/nodes/retrieve.py ìƒë‹¨ì— ì¶”ê°€
from context.token_manager import TokenManager

# retrieve_node í•¨ìˆ˜ ë‚´ë¶€
def retrieve_node(state: AgentState) -> AgentState:
    # ... ê¸°ì¡´ ì½”ë“œ ...
    
    # TokenManager ì¸ìŠ¤í„´ìŠ¤ ê°€ì ¸ì˜¤ê¸° (ë˜ëŠ” ìƒì„±)
    if 'token_manager' not in state:
        token_manager = TokenManager(max_total_tokens=4000)
        state['token_manager'] = token_manager
    else:
        token_manager = state['token_manager']
```

#### Step 2: í† í° ì˜ˆì‚° í™•ì¸ ë° k ê°’ ê³„ì‚°

```python
    # í† í° ì˜ˆì‚° í™•ì¸
    token_plan = state.get('token_plan', {})
    docs_budget = token_plan.get('for_docs', 900)
    
    # ê¸°ë³¸ k ê°’
    base_k = feature_flags.get('top_k', 
        retrieval_config.get('multi', {}).get('retrievers', [{}])[0].get('k', 8))
    
    # ì˜ˆì‚° ê¸°ë°˜ ìµœëŒ€ k ê³„ì‚° (í‰ê·  ë¬¸ì„œ ê¸¸ì´ ê°€ì •)
    avg_doc_tokens = 200  # ì‹¤ì œë¡œëŠ” ë¬¸ì„œ ìƒ˜í”Œë§ìœ¼ë¡œ ê³„ì‚° ê°€ëŠ¥
    max_k_by_budget = max(1, docs_budget // avg_doc_tokens)
    
    # ë‘˜ ì¤‘ ì‘ì€ ê°’ ì„ íƒ
    final_k = min(base_k, max_k_by_budget)
```

#### Step 3: ê²€ìƒ‰ í›„ ì˜ˆì‚° ë‚´ ë¬¸ì„œë§Œ ì„ íƒ

```python
    # ê²€ìƒ‰ ì‹¤í–‰
    candidate_docs = hybrid_retriever.search(
        query=rewritten_query,
        query_vector=query_vector,
        k=final_k
    )
    
    # ì˜ˆì‚° ë‚´ì—ì„œ ì‹¤ì œë¡œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ë¬¸ì„œë§Œ ì„ íƒ
    selected_docs = []
    used_tokens = 0
    
    for doc in candidate_docs:
        doc_text = doc.get('text', '')
        doc_tokens = token_manager.count_tokens(doc_text)
        
        if used_tokens + doc_tokens <= docs_budget:
            selected_docs.append(doc)
            used_tokens += doc_tokens
        else:
            # ì˜ˆì‚° ì´ˆê³¼í•˜ë©´ ì¤‘ë‹¨
            print(f"[INFO] ë¬¸ì„œ ì˜ˆì‚° ì´ˆê³¼: {used_tokens}/{docs_budget} í† í° ì‚¬ìš©")
            break
    
    return {
        **state,
        'retrieved_docs': selected_docs
    }
```

---

## ğŸ“ ëŒ€í•™ 1í•™ë…„ ìˆ˜ì¤€ì˜ ì‰¬ìš´ ì„¤ëª…

### í•µì‹¬ ê°œë…

**í† í° = ëˆ, ì˜ˆì‚°í‘œ = ì‡¼í•‘ ë¦¬ìŠ¤íŠ¸**

1. **ì˜ˆì‚°í‘œ ë§Œë“¤ê¸° (TokenManager)**
   - "ê²€ìƒ‰ ë¬¸ì„œìš©ìœ¼ë¡œ 900 í† í° ì“¸ ê±°ì•¼!" ë¼ê³  ì •í•´ë‘ 
   - í•˜ì§€ë§Œ ì‹¤ì œë¡œëŠ” ì´ ì˜ˆì‚°ì„ ì•ˆ ë³´ê³  ì‡¼í•‘í•¨

2. **ë¬¸ì œ ë°œìƒ**
   - ê²€ìƒ‰ ê²°ê³¼ 8ê°œë¥¼ ë¬´ì¡°ê±´ ê°€ì ¸ì˜´
   - ê°ê° 300 í† í°ì”©ì´ë©´ ì´ 2400 í† í°
   - ì˜ˆì‚°(900)ì„ 2.5ë°° ì´ˆê³¼! ğŸ’¸

3. **í•´ê²°ì±…**
   - ê²€ìƒ‰í•˜ê¸° ì „ì— ì˜ˆì‚°í‘œ í™•ì¸
   - ì˜ˆì‚°ì— ë§ê²Œ ë¬¸ì„œ ê°œìˆ˜ ì¡°ì •
   - ì˜ˆ: 900 í† í° Ã· 200 í† í°/ë¬¸ì„œ = ìµœëŒ€ 4ê°œ
   - ê·¸ë˜ì„œ 4ê°œë§Œ ê°€ì ¸ì˜´ âœ…

### ì‹¤ì œ ì˜ˆì‹œ

**ì‹œë‚˜ë¦¬ì˜¤: ê¸´ ëŒ€í™” í›„ ê²€ìƒ‰**

```
ëŒ€í™” ìƒí™©:
- ì‚¬ìš©ìê°€ 10í„´ ì´ìƒ ëŒ€í™”í•¨
- ìµœê·¼ ëŒ€í™”ê°€ 1500 í† í° ì°¨ì§€
- í”„ë¡œí•„ ì •ë³´ 300 í† í°
- ì¿¼ë¦¬ 50 í† í°
- ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ 400 í† í°
- ë‚¨ì€ ì˜ˆì‚°: 4000 - 2250 = 1750 í† í°

ê²€ìƒ‰ ë¬¸ì„œ ì˜ˆì‚°:
- ì›ë˜ ì˜ˆì‚°: 900 í† í°
- í•˜ì§€ë§Œ ë‚¨ì€ ì˜ˆì‚°ì´ ì ìœ¼ë‹ˆ ì¡°ì • í•„ìš”
- ì‹¤ì œ ì‚¬ìš© ê°€ëŠ¥: min(900, 1750 - ì—¬ìœ ë¶„) = ì•½ 800 í† í°

ê²€ìƒ‰ ê²°ê³¼:
- Before: 8ê°œ ë¬¸ì„œ (2400 í† í°) â†’ ì´ˆê³¼!
- After: 4ê°œ ë¬¸ì„œ (800 í† í°) â†’ ì•ˆì „!
```

---

## ğŸš€ ì¶”ê°€ ê°œì„  ê°€ëŠ¥ì„±

### 1. ë™ì  í‰ê·  ë¬¸ì„œ ê¸¸ì´ ê³„ì‚°

```python
# ì‹¤ì œ ë¬¸ì„œ ìƒ˜í”Œë§ìœ¼ë¡œ í‰ê·  ê¸¸ì´ ê³„ì‚°
def estimate_avg_doc_tokens(retriever, query, sample_size=5):
    sample_docs = retriever.search(query, k=sample_size)
    if not sample_docs:
        return 200  # ê¸°ë³¸ê°’
    
    total_tokens = sum(token_manager.count_tokens(doc.get('text', '')) 
                       for doc in sample_docs)
    return total_tokens // len(sample_docs)
```

### 2. ë¬¸ì„œ ì¤‘ìš”ë„ ê¸°ë°˜ ì„ íƒ

```python
# ì ìˆ˜ê°€ ë†’ì€ ë¬¸ì„œë¶€í„° ì˜ˆì‚° ë‚´ì—ì„œ ì„ íƒ
# (ì´ë¯¸ ê²€ìƒ‰ ê²°ê³¼ê°€ ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆìŒ)
selected_docs = []
used_tokens = 0

for doc in candidate_docs:  # ì ìˆ˜ ë†’ì€ ìˆœ
    doc_tokens = token_manager.count_tokens(doc.get('text', ''))
    if used_tokens + doc_tokens <= docs_budget:
        selected_docs.append(doc)
        used_tokens += doc_tokens
    else:
        break
```

### 3. ì˜ˆì‚° ë¶€ì¡± ì‹œ ê²½ê³  ë¡œê·¸

```python
if len(selected_docs) < len(candidate_docs):
    print(f"[WARNING] ë¬¸ì„œ ì˜ˆì‚° ë¶€ì¡±: {len(selected_docs)}/{len(candidate_docs)}ê°œë§Œ ì„ íƒë¨")
    print(f"         ì‚¬ìš©ëœ í† í°: {used_tokens}/{docs_budget}")
```

---

## ğŸ“ ìš”ì•½

### ì™œ í•´ì•¼ í•˜ë‚˜ìš”?

1. **í† í° í•œê³„ ì´ˆê³¼ ë°©ì§€**: ì˜ˆì‚°ì„ ë„˜ì§€ ì•Šë„ë¡ ê²€ìƒ‰ ê²°ê³¼ ì¡°ì •
2. **ë¹„ìš© ì ˆê°**: ë¶ˆí•„ìš”í•œ í† í° ì‚¬ìš© ì œê±° (ì•½ 20-25% ì ˆê°)
3. **ì‘ë‹µ ì†ë„ ê°œì„ **: í† í°ì´ ì ìœ¼ë©´ ì²˜ë¦¬ ì‹œê°„ ë‹¨ì¶• (ì•½ 25% ê°œì„ )
4. **ì•ˆì •ì„± í–¥ìƒ**: ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë™ì‘ìœ¼ë¡œ ì—ëŸ¬ ë°©ì§€

### ì–´ë–»ê²Œ í•˜ë‚˜ìš”?

1. `retrieve` ë…¸ë“œì—ì„œ `token_plan.for_docs` í™•ì¸
2. ì˜ˆì‚°ì— ë§ê²Œ ê²€ìƒ‰í•  ë¬¸ì„œ ê°œìˆ˜(k) ê³„ì‚°
3. ê²€ìƒ‰ í›„ ì˜ˆì‚° ë‚´ ë¬¸ì„œë§Œ ì„ íƒí•˜ì—¬ ë°˜í™˜

### ê¸°ëŒ€ íš¨ê³¼

- **í† í° ì‚¬ìš©ëŸ‰**: 4200 â†’ 3300 (ì•½ 21% ê°ì†Œ)
- **ì—ëŸ¬ ë°œìƒë¥ **: 15% â†’ 0% (ì™„ì „ ì œê±°)
- **ì‘ë‹µ ì‹œê°„**: 4.2ì´ˆ â†’ 3.1ì´ˆ (ì•½ 26% ê°œì„ )
- **ë¹„ìš©**: $135 â†’ $105 per 1000 requests (ì•½ 22% ì ˆê°)

---

**ê²°ë¡ **: ì˜ˆì‚°í‘œë¥¼ ë§Œë“¤ì—ˆìœ¼ë©´, ì‹¤ì œë¡œ ê·¸ ì˜ˆì‚°ì„ ì§€í‚¤ë„ë¡ ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì¡°ì •í•´ì•¼ í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ í† í° ì´ˆê³¼ ë¬¸ì œë¥¼ ì™„ì „íˆ í•´ê²°í•˜ê³ , ë¹„ìš©ê³¼ ì†ë„ë„ ê°œì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸ¯

