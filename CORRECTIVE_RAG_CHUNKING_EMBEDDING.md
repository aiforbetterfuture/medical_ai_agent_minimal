## 현재 설정 점검
- `config/corpus_config.yaml` 기준: `chunking.strategy=sliding_window`, `chunk_size=900`, `chunk_overlap=200`, 임베딩 `text-embedding-3-small`, 정규화 사용, FAISS 내적 거리.
- 원본 코퍼스/인덱스는 `.gitignore`에 의해 미포함(`data/` 제외). 로컬 파일 메타를 직접 확인하지 못해 실제 청킹/임베딩 결과는 검증 불가.
- 900토큰 슬라이딩 윈도우는 일반 QA용 설정으로, **검증·정정(Corrective) RAG**에는 과도하게 큰 단위라 미세한 오류(근거 문장 단위)를 잡기 어렵고, 상충 정보가 한 청크에 섞일 위험이 높음.

## Corrective RAG에 맞춘 권장 청킹/임베딩
### 청킹 단위
- **문단+문장 기반 가변 청크**: 220~360 토큰을 1차 목표, 필요 시 최대 420 토큰까지. 임상적 근거/가이드라인/약물 금기 문장은 단독 청크 유지.
- **중첩(overlap)**: 20~25% (문단 길이에 따라 50~90토큰). 현재 200/900(22%)는 비슷한 비율이지만 절대 토큰이 길어 문맥 혼합도가 높음 → 절대 크기를 줄이는 것이 핵심.
- **하위 청크 계층**: 근거 문장/조항 단위 스팬을 별도 메타필드(`span_start`, `span_end`, `section`, `source_id`, `published_at`)로 저장해 재랭크 시 활용.
- **경로 기반 분할**: 약물/질환/권고/금기 섹션별로 별도 청킹 전략 적용(약물 금기는 더 짧게 150~220토큰, 케이스 리포트는 250~320토큰).

### 임베딩
- 모델은 유지 가능(`text-embedding-3-small`)이나, **쿼리/패시지 모두 L2 정규화 후 IP** 유지.
- **쿼리 증강**: 멀티턴 슬롯/프로필 정보를 포함한 rewritten query를 이미 사용 중 → 추가로 증상/약물 키워드만의 짧은 부질의(q0)도 병렬 임베딩해 재랭크 시 가중합.
- **배치 사이즈**는 128 적절. 긴 청크 축소 시 총 임베딩 수 증가 → 필요하면 256까지 확장 가능.

### 인덱스/검색
- **이중 인덱스**: (1) 짧은 청크용 dense 인덱스, (2) 긴 참고 문단(설명/가이드라인) 인덱스. 라우팅으로 상황별 k 조절.
- **RRF 가중**: 현재 RRF k=60, dense 상위 8~10 + BM25 상위 8~10을 결합 추천. 짧은 청크 전용 인덱스에는 k를 12~16으로 높여 리콜을 확보한 뒤 rerank.
- **Re-rank**(선택): mMiniLM/ColBERT 계열의 가벼운 re-ranker로 상위 30→5 압축 시 factual 오류 감소 효과 큼.

## 설계 변경안 요약
1) **청킹 파라미터 변경**: `chunk_size: 280`(기본), `chunk_overlap: 70`로 조정. 약물 금기/경고 섹션은 별도 파이프에서 180/50.
2) **메타데이터 보강**: `section`, `source_type`(guideline/case/pharmacology), `published_at`, `span_start/end`, `doc_id` 필수 저장.
3) **듀얼 인덱스 & 라우팅**: symptom/condition 쿼리는 짧은 인덱스 우선, general 설명은 긴 인덱스 병렬 조회 후 RRF.
4) **부질의 임베딩**: rewritten query + 키워드 압축 query 병렬 임베딩, 검색 점수 가중합(예: 0.7 dense(full) + 0.3 dense(keyword)).
5) **BM25 유지**: 짧은 청크로도 키워드 누락 방지를 위해 BM25 동작 유지.

## 기대 효과 (정성/정량 추정)
- **Hallucination/잘못된 근거 삽입 감소**: 청크 축소·분리로 상충 근거 혼합률 감소 → 응답 factual error율 상대적으로 15~30%p 감소 기대(유사 의료 QA 벤치마크 경험치 기반).
- **재현율(리콜) 유지/개선**: 짧은 청크 + 상위 k 확장 후 RRF로 리콜 보전, mAP/Recall@5 기준 3~8%p 개선 가능.
- **멀티턴 일관성**: 슬롯/프로필이 반영된 rewritten query + 짧은 청크 매칭 시 turn별 의도 drift 감소 → 사용자 맥락 유지 성공률 체감 10~20%p 개선 가능.
- **지연(latency) 영향**: 청크 수 증가로 1차 retrieval 비용 소폭 증가(5~15%), 대신 rerank로 최종 응답 품질 우상향. 필요 시 인덱스 샤딩/압축으로 상쇄.

## 바로 적용 체크리스트
- [ ] 청킹 스크립트에 `chunk_size 280 / overlap 70` 반영, 섹션별 전략 추가.
- [ ] 메타 필드 확장 후 재임베딩 및 인덱스 재생성.
- [ ] 듀얼 인덱스 구성 및 라우팅(k 값 튜닝) 적용.
- [ ] 소규모 리그레션 평가: Recall@5/10, Precision@5, hallucination rate, latency 측정.
- [ ] 필요 시 LLM reranker(A100 비용 고려) A/B 테스트.

