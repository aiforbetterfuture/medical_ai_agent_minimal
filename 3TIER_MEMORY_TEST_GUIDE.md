# 3-Tier 메모리 시스템 성능 테스트 가이드

## 개요

3계층 메모리 시스템의 성능을 검증하기 위한 21턴 멀티턴 테스트입니다.

### 메모리 계층 구조

1. **Working Memory (Tier 1)**: 최근 5턴
   - 원문 그대로 저장
   - 즉시 접근 가능
   - 빠른 응답 생성

2. **Compressing Memory (Tier 2)**: 6-20턴
   - LLM 기반 압축 요약
   - 핵심 의료 정보 추출
   - 메모리 효율성 향상

3. **Semantic Memory (Tier 3)**: 21턴 이상
   - 장기 저장
   - 만성 질환, 약물, 알레르기 등
   - 지속적인 건강 패턴 추적

## 테스트 시나리오

### 1. 가상 환자 생성 (LLM 기반)

```python
# 복잡한 의료 상황을 가진 가상 환자 프로파일 생성
{
  "patient_id": "VIRTUAL_001",
  "age": 65,
  "sex": "남성",
  "primary_conditions": ["당뇨병", "고혈압", "고지혈증"],
  "current_symptoms": ["피로감", "어지러움", "가슴 답답함"],
  "medications": ["메트포르민", "리시노프릴", "아토르바스타틴"],
  "lab_results": {"HbA1c": "7.2%", "혈압": "145/90"},
  "concerns": ["합병증 예방", "생활습관 개선"]
}
```

### 2. 21턴 질문 생성

**Turn 1-5: 기본 정보 및 현재 상태 파악**
- 명시적 질문
- 환자 프로파일 기반
- 예: "저는 65세 남성이고 당뇨병이 있습니다. 최근 피로감이 심한데 어떤 검사를 받아야 하나요?"

**Turn 6-10: 증상 상세 및 약물 관련**
- 일부 맥락 의존
- 이전 대화 참조
- 예: "그 검사 결과가 나오면 약을 바꿔야 하나요?" (맥락: Turn 1-5의 검사 언급)

**Turn 11-15: 생활습관 및 관리 방안**
- 맥락 의존
- 압축 메모리 활용 테스트
- 예: "제 상황에서 운동은 어떻게 해야 하나요?" (맥락: 전체 건강 상태)

**Turn 16-20: 장기 관리 계획**
- 강한 맥락 의존
- 압축 메모리 + Working Memory 통합
- 예: "앞으로 6개월 동안 어떤 점을 주의해야 하나요?"

**Turn 21: 종합 관리 계획**
- 전체 맥락 의존
- Semantic Memory 활성화
- 예: "지금까지 얘기한 모든 것을 종합해서 1년 관리 계획을 만들어주세요."

### 3. AI Agent 모드 실행

각 턴마다:
1. 질문 입력
2. 메모리 검색 (3계층)
3. 문서 검색 (RAG)
4. 답변 생성
5. 메모리 업데이트
6. 평가지표 계산

### 4. 메모리 스냅샷 캡처

각 턴마다 메모리 상태 저장:
```json
{
  "turn_id": 10,
  "working_memory": {
    "size": 5,
    "items": [
      {"turn": 6, "question": "...", "answer": "..."},
      {"turn": 7, "question": "...", "answer": "..."},
      ...
    ]
  },
  "compressing_memory": {
    "size": 1,
    "summaries": [
      {
        "turn_range": "1-5",
        "summary": "환자는 65세 남성으로 당뇨병, 고혈압, 고지혈증을 앓고 있으며..."
      }
    ]
  },
  "semantic_memory": {
    "size": 0,
    "entries": []
  }
}
```

## 실행 방법

### Windows (Batch 파일)

```bash
11_test_3tier_memory.bat
```

### Python 직접 실행

```bash
.venv\Scripts\python.exe experiments\test_3tier_memory_21turns.py
```

## 예상 결과

### 소요 시간
- **가상 환자 생성**: 1-2분
- **21턴 질문 생성**: 2-3분
- **21턴 대화 수행**: 10-20분
  - 각 턴당 30-60초
  - RAGAS 평가 포함
- **총 소요 시간**: 15-30분

### API 비용
- **가상 환자 생성**: $0.05-0.10
- **21턴 질문 생성**: $0.10-0.20
- **21턴 대화 수행**: $0.80-1.50
  - LLM 호출: $0.50-1.00
  - RAGAS 평가: $0.30-0.50
- **총 API 비용**: $1-2

### 출력 파일

1. **test_results_YYYYMMDD_HHMMSS.json**
   - 전체 테스트 결과
   - 환자 프로파일
   - 21턴 대화 내용
   - 평가지표

2. **memory_snapshots_YYYYMMDD_HHMMSS.json**
   - 각 턴마다의 메모리 스냅샷
   - 3계층 메모리 상태 변화

3. **memory_visualization_YYYYMMDD_HHMMSS.md**
   - 메모리 시각화
   - 계층별 내용 요약
   - 성능 분석

## 평가지표

### RAGAS 메트릭
- **Faithfulness**: 답변이 검색된 문서에 근거하는지
- **Answer Relevance**: 답변이 질문과 관련있는지
- **Perplexity**: 답변의 불확실성

### 메모리 성능 메트릭
- **Working Memory 활용도**: 최근 5턴 참조 빈도
- **Compressing Memory 품질**: 압축 요약의 정확성
- **Semantic Memory 효과**: 장기 정보 활용도

### 응답 품질 메트릭
- **응답 시간**: 각 턴의 응답 생성 시간
- **검색 문서 수**: 각 턴에서 검색된 문서 수
- **응답 길이**: 답변의 길이 (토큰 수)

## 시각화 예시

### 메모리 계층별 상태 변화

```
Turn 1-5: Working Memory만 사용
├── Turn 1: [원문]
├── Turn 2: [원문]
├── Turn 3: [원문]
├── Turn 4: [원문]
└── Turn 5: [원문]

Turn 6-10: Compressing Memory 활성화
├── Working Memory (5개)
│   ├── Turn 6: [원문]
│   ├── Turn 7: [원문]
│   ├── Turn 8: [원문]
│   ├── Turn 9: [원문]
│   └── Turn 10: [원문]
└── Compressing Memory (1개)
    └── Turn 1-5: [압축 요약]

Turn 11-20: Compressing Memory 확장
├── Working Memory (5개)
│   ├── Turn 16: [원문]
│   ├── Turn 17: [원문]
│   ├── Turn 18: [원문]
│   ├── Turn 19: [원문]
│   └── Turn 20: [원문]
└── Compressing Memory (3개)
    ├── Turn 1-5: [압축 요약]
    ├── Turn 6-10: [압축 요약]
    └── Turn 11-15: [압축 요약]

Turn 21: Semantic Memory 활성화
├── Working Memory (5개)
│   ├── Turn 17: [원문]
│   ├── Turn 18: [원문]
│   ├── Turn 19: [원문]
│   ├── Turn 20: [원문]
│   └── Turn 21: [원문]
├── Compressing Memory (3개)
│   ├── Turn 1-5: [압축 요약]
│   ├── Turn 6-10: [압축 요약]
│   └── Turn 11-15: [압축 요약]
└── Semantic Memory (N개)
    ├── chronic_conditions: [당뇨병, 고혈압, ...]
    ├── chronic_medications: [메트포르민, ...]
    └── health_patterns: {...}
```

## 성능 분석 포인트

### 1. Working Memory (Turn 1-5)
- **목표**: 원문 저장 및 즉시 접근
- **측정**: 응답 시간, 정확도
- **기대**: 빠른 응답, 높은 정확도

### 2. Compressing Memory (Turn 6-20)
- **목표**: 압축 요약으로 메모리 효율성 향상
- **측정**: 압축률, 정보 손실률, 응답 품질
- **기대**: 메모리 사용량 감소, 응답 품질 유지

### 3. Semantic Memory (Turn 21+)
- **목표**: 장기 정보 저장 및 활용
- **측정**: 장기 정보 참조 빈도, 응답 일관성
- **기대**: 전체 맥락 이해, 종합적 답변

### 4. 계층 간 통합
- **목표**: 3계층 메모리 통합 활용
- **측정**: 계층 간 정보 전달 효율성
- **기대**: 단기/중기/장기 정보 조화로운 활용

## 문제 해결

### 가상 환자 생성 실패
```
원인: LLM API 호출 실패
해결: API 키 확인, 네트워크 연결 확인
```

### 메모리 압축 실패
```
원인: LLM 요약 생성 실패
해결: 원본 유지, 로그 확인
```

### RAGAS 평가 느림
```
원인: 각 턴마다 30-60초 소요
해결: 인내심 가지고 대기, 진행 상황 로그 확인
```

## 결론

이 테스트를 통해 다음을 확인할 수 있습니다:

1. **3계층 메모리 시스템의 작동 여부**
2. **각 계층의 성능 및 효율성**
3. **계층 간 전환의 원활함**
4. **장기 대화에서의 메모리 관리 능력**
5. **평가지표를 통한 정량적 성능 측정**

테스트 결과를 바탕으로 메모리 시스템을 최적화하고, 석사 논문의 실험 결과로 활용할 수 있습니다! 🎓

